<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>币安U本位合约K线图表</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .controls h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .price-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .price-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .price-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .price-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .price-up {
            color: #28a745;
        }
        
        .price-down {
            color: #dc3545;
        }
        
        .refresh-btn {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .ema-signal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .ema-signal-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .ema-signal-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 币安U本位合约K线图表</h1>
            <p>实时查看交易对K线数据，支持4小时和15分钟周期</p>
        </div>
        
        <div class="content">
            <!-- 控制面板 -->
            <div class="controls">
                <h3>🎯 交易对选择</h3>
                <div class="form-group">
                    <label for="symbol-select">选择交易对:</label>
                    <select id="symbol-select" onchange="onSymbolChange()">
                        <option value="">请选择交易对...</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="loadSymbols()">刷新交易对列表</button>
                <button class="btn btn-info" onclick="loadCurrentData()">刷新当前数据</button>
                <div id="symbol-count" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
            </div>
            
            <!-- EMA信号展示区 -->
            <div class="ema-signal-grid">
                <div id="ema-signal-panel-4h" class="ema-signal-panel"></div>
                <div id="ema-signal-panel-15m" class="ema-signal-panel"></div>
            </div>
            
            <!-- 价格信息 -->
            <div id="price-info" class="price-info" style="display: none;">
                <h3>💰 实时价格信息</h3>
                <div class="price-grid">
                    <div class="price-item">
                        <div class="price-label">最新价格</div>
                        <div class="price-value" id="last-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24h涨跌幅</div>
                        <div class="price-value" id="price-change">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24h最高价</div>
                        <div class="price-value" id="high-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24h最低价</div>
                        <div class="price-value" id="low-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24h成交量</div>
                        <div class="price-value" id="volume">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24h成交额</div>
                        <div class="price-value" id="quote-volume">--</div>
                    </div>
                </div>
            </div>
            
            <!-- K线图表 -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>📊 4小时K线图</h3>
                    <div class="chart-wrapper" id="tv_chart_4h"></div>
                    <div class="chart-wrapper" style="display:none;">
                        <canvas id="chart-4h"></canvas>
                    </div>
                    <button class="btn refresh-btn" onclick="loadKlineData('4h')">刷新4H数据</button>
                </div>
                
                <div class="chart-container">
                    <h3>📈 15分钟K线图</h3>
                    <div class="chart-wrapper" id="tv_chart_15m"></div>
                    <div class="chart-wrapper" style="display:none;">
                        <canvas id="chart-15m"></canvas>
                    </div>
                    <button class="btn refresh-btn" onclick="loadKlineData('15m')">刷新15M数据</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let symbolsList = [];
        let currentSymbol = '';
        let chart4h = null;
        let chart15m = null;
        let emaSignalTimer = null;
        
        // ====== 缓存机制 ======
        window.klineCache = {}; // { 'BTCUSDT-4h': {data, ts} }
        window.emaCache = {};   // { 'BTCUSDT-4h': {data, ts} }
        window.symbolsList = [];
        window.symbolLeverageMap = {};
        const KLINE_CACHE_TTL = 30 * 1000; // 30秒
        const EMA_CACHE_TTL = 30 * 1000;

        // 页面加载完成后自动加载数据
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            // 在信号区下方插入下单机会和交易板块（上下排列）
            const signalGrid = document.querySelector('.ema-signal-grid');
            if (signalGrid) {
                // 下单机会
                let oppoDiv = document.createElement('div');
                oppoDiv.id = 'order-opportunity-panel';
                oppoDiv.style = 'margin:32px 0 0 0;font-size:1.1em;width:100%;max-width:900px;';
                signalGrid.parentNode.insertBefore(oppoDiv, signalGrid.nextSibling);

                // 交易板块
                let tradeBlock = document.createElement('div');
                tradeBlock.id = 'trade-block-desc';
                tradeBlock.style = 'margin-top:24px;margin-bottom:20px;width:100%;background:#f8f9fa;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:18px 24px 18px 24px;';
                tradeBlock.innerHTML = `
<div style="font-weight:bold;font-size:1.25em;color:#2a4fa0;margin-bottom:12px;letter-spacing:1px;">交易板块</div>
<div style="display:flex;gap:30px;flex-wrap:wrap;align-items:flex-start;">
  <div style="flex:1;min-width:220px;">
    <div style="margin-bottom:12px;font-size:1em;color:#333;">交易所：
      <select id="trade-exchange-select" style="padding:6px 12px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;outline:none;">
        <option value="aster">aster</option>
        <option value="backpack">backpack</option>
      </select>
    </div>
    <div style="margin-bottom:12px;font-size:1em;color:#333;">杠杆设置：<input id="trade-leverage" type="number" min="1" max="125" value="50" style="width:60px;padding:4px 8px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;"> <span style="color:#888;">（默认为50倍）</span></div>
    <div id="trade-leverage-desc" style="margin-top:8px;color:#444;font-size:1em;"></div>
  </div>
  <div style="flex:1;min-width:180px;display:flex;align-items:center;flex-direction:column;">
    <div style="font-size:1em;color:#333;">账户余额：<span style='font-weight:bold;color:#2a4fa0;' id="trade-balance-usdt">加载中...</span></div>
    <div style="margin-top:18px;margin-bottom:0;width:100%;text-align:center;">
      <span style="font-size:1em;color:#333;margin-right:8px;vertical-align:middle;">方向选择：</span>
      <select id="trade-direction-select" style="padding:6px 12px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;outline:none;width:80%;max-width:220px;vertical-align:middle;">
        <option value="long">多（做多/买入）</option>
        <option value="short">空（做空/卖出）</option>
      </select>
      <div style="margin-top:18px;">
        <button id="btn-open-order" style="padding:8px 28px;font-size:1.08em;border:none;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-weight:bold;cursor:pointer;margin-right:18px;transition:background 0.2s;">下单</button>
        <button id="btn-close-order" style="padding:8px 28px;font-size:1.08em;border:none;border-radius:6px;background:linear-gradient(135deg,#f44336 0%,#ff7961 100%);color:white;font-weight:bold;cursor:pointer;transition:background 0.2s;">平仓</button>
      </div>
    </div>
  </div>
  <div style="flex:1;min-width:220px;">
    <div style="margin-bottom:12px;font-size:1em;color:#333;">下单金额：<input id="trade-amount" type="number" min="1" value="150" style="width:80px;padding:4px 8px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;"> <span style="color:#888;">（默认为150）</span></div>
    <div style="font-size:0.98em;color:#666;">此处显示最大可以下单的金额=账户余额*0.7*杠杆倍数<br><span id="trade-max-amount" style="color:#2a4fa0;font-weight:bold;font-size:1.1em;"></span></div>
  </div>
</div>
`;
                oppoDiv.parentNode.insertBefore(tradeBlock, oppoDiv.nextSibling);
                // 事件绑定和动态功能
                function updateMaxAmount() {
                  // 从余额元素获取主要余额（优先USDT，其次USDC，然后其他）
                  let mainBalance = Number(document.getElementById('trade-balance-usdt').getAttribute('data-balance')) || 0;
                  let leverage = Number(document.getElementById('trade-leverage').value) || 50;
                  let maxAmt = mainBalance * 0.7 * leverage;
                  document.getElementById('trade-max-amount').textContent = '最大可下单金额：' + maxAmt.toFixed(2);
                  // 限制下单金额输入框最大值
                  document.getElementById('trade-amount').max = Math.floor(maxAmt);
                }
                window.updateMaxAmount = updateMaxAmount;
                document.getElementById('trade-leverage').addEventListener('input', updateMaxAmount);
                document.getElementById('trade-leverage').addEventListener('change', updateMaxAmount);
                document.getElementById('trade-leverage').addEventListener('blur', updateMaxAmount);
                document.getElementById('trade-exchange-select').addEventListener('change', function() {
                  // 若选择backpack，杠杆强制50
                  if (this.value === 'backpack') {
                    document.getElementById('trade-leverage').value = 50;
                    document.getElementById('trade-leverage').setAttribute('readonly', 'readonly');
                  } else {
                    document.getElementById('trade-leverage').removeAttribute('readonly');
                  }
                  updateAccountBalance();
                  updateLeverageDesc();
                });
                document.getElementById('trade-amount').addEventListener('input', updateMaxAmount);
                // 初始化余额和最大金额
                updateAccountBalance();
                updateLeverageDesc();
            }
            // 下单按钮事件
            const btnOpenOrder = document.getElementById('btn-open-order');
            if (btnOpenOrder) {
                btnOpenOrder.onclick = async function() {
                    const exchange = document.getElementById('trade-exchange-select').value;
                    const symbol = document.getElementById('symbol-select').value;
                    const amount = document.getElementById('trade-amount').value;
                    const direction = document.getElementById('trade-direction-select').value;
                    const order_type = 'MARKET'; // 可扩展
                    const leverage = document.getElementById('trade-leverage').value;
                    if (!symbol || !exchange || !amount || !direction) {
                        alert('请填写完整下单信息');
                        return;
                    }
                    btnOpenOrder.disabled = true;
                    btnOpenOrder.textContent = '下单中...';
                    try {
                        const resp = await fetch('/api/unified_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol,
                                exchange,
                                amount,
                                direction,
                                order_type,
                                leverage
                            })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            alert('下单成功！');
                        } else {
                            alert('下单失败：' + data.error);
                        }
                    } catch (e) {
                        alert('网络错误：' + e);
                    }
                    btnOpenOrder.disabled = false;
                    btnOpenOrder.textContent = '下单';
                };
            }
            // 平仓按钮事件
            const btnCloseOrder = document.getElementById('btn-close-order');
            if (btnCloseOrder) {
                btnCloseOrder.onclick = async function() {
                    const exchange = document.getElementById('trade-exchange-select').value;
                    const symbol = document.getElementById('symbol-select').value;
                    const direction = document.getElementById('trade-direction-select').value;
                    if (!symbol || !exchange) {
                        alert('请填写完整平仓信息');
                        return;
                    }
                    btnCloseOrder.disabled = true;
                    btnCloseOrder.textContent = '平仓中...';
                    try {
                        const resp = await fetch('/api/unified_close_position', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol,
                                exchange,
                                direction
                            })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            alert('平仓成功！');
                        } else {
                            alert('平仓失败：' + data.error);
                        }
                    } catch (e) {
                        alert('网络错误：' + e);
                    }
                    btnCloseOrder.disabled = false;
                    btnCloseOrder.textContent = '平仓';
                };
            }
        });

        // 查询账户余额并更新显示
        async function updateAccountBalance() {
            const exchange = document.getElementById('trade-exchange-select').value;
            let balanceHtml = '';
            let mainBalance = 0;
            try {
                const resp = await fetch(`/api/account?exchange=${exchange}`);
                const data = await resp.json();
                if (data.success && data.account && data.account.assets) {
                    // 参照index.html的处理方式：优先USDT，其次USDC，然后其他币种
                    let usdt = data.account.assets.find(a => a.asset === 'USDT');
                    let usdc = data.account.assets.find(a => a.asset === 'USDC');
                    
                    if (usdt && parseFloat(usdt.walletBalance) > 0) {
                        balanceHtml += `<span style='font-weight:bold;'>usdt: ${parseFloat(usdt.walletBalance).toFixed(2)}</span>`;
                        mainBalance = parseFloat(usdt.walletBalance);
                    }
                    
                    if (usdc && parseFloat(usdc.walletBalance) > 0) {
                        if (balanceHtml) balanceHtml += ', ';
                        balanceHtml += `<span style='font-weight:bold;'>usdc: ${parseFloat(usdc.walletBalance).toFixed(2)}</span>`;
                        if (!mainBalance) mainBalance = parseFloat(usdc.walletBalance);
                    }
                    
                    // 显示其他有余额的币种
                    data.account.assets.forEach(asset => {
                        if (asset.asset !== 'USDT' && asset.asset !== 'USDC' && parseFloat(asset.walletBalance) > 0) {
                            if (balanceHtml) balanceHtml += ', ';
                            balanceHtml += `<span style='font-weight:bold;'>${asset.asset.toLowerCase()}: ${parseFloat(asset.walletBalance).toFixed(2)}</span>`;
                            if (!mainBalance) mainBalance = parseFloat(asset.walletBalance);
                        }
                    });
                }
            } catch (e) {
                balanceHtml = '<span style="color:red;">获取失败</span>';
            }
            
            // 更新余额显示
            const balanceElement = document.getElementById('trade-balance-usdt');
            balanceElement.innerHTML = balanceHtml || '<span style="color:gray;">无余额</span>';
            balanceElement.setAttribute('data-balance', mainBalance);
            
            // 更新最大可下单金额
            if (typeof updateMaxAmount === 'function') updateMaxAmount();
        }

        // 交易板块说明区动态最大杠杆显示（异步防抖，确保每次都请求API）
        let leverageRequestId = 0;
        async function updateLeverageDesc() {
          const exchange = document.getElementById('trade-exchange-select').value;
          const symbol = document.getElementById('symbol-select').value;
          const descDiv = document.getElementById('trade-leverage-desc');
          const leverageInput = document.getElementById('trade-leverage');
          if (exchange === 'backpack') {
            descDiv.innerHTML = 'backpack交易所所有代币下单杠杆为<b>50</b>';
            leverageInput.max = 50;
            if (parseInt(leverageInput.value) > 50) leverageInput.value = 50;
            return;
          }
          if (!symbol) {
            descDiv.innerHTML = '';
            leverageInput.removeAttribute('max');
            return;
          }
          descDiv.innerHTML = '查询中...';
          const reqId = ++leverageRequestId;
          try {
            const resp = await fetch(`/api/max_leverage?symbol=${symbol}&exchange=${exchange}`);
            const data = await resp.json();
            if (reqId !== leverageRequestId) return; // 已有新请求，丢弃旧响应
            if (data.success) {
              descDiv.innerHTML = `该币种最大杠杆：<b>${data.maxLeverage}</b>倍`;
              leverageInput.max = data.maxLeverage;
              if (parseInt(leverageInput.value) > data.maxLeverage) {
                leverageInput.value = data.maxLeverage;
              }
              if (typeof updateMaxAmount === 'function') updateMaxAmount();
            } else {
              descDiv.innerHTML = '无法获取该币种最大杠杆';
              leverageInput.removeAttribute('max');
              if (typeof updateMaxAmount === 'function') updateMaxAmount();
            }
          } catch {
            if (reqId !== leverageRequestId) return;
            descDiv.innerHTML = '无法获取该币种最大杠杆';
            leverageInput.removeAttribute('max');
            if (typeof updateMaxAmount === 'function') updateMaxAmount();
          }
        }
        
        // 加载交易对列表（本地缓存+API）
        async function loadSymbols(force=false) {
            const symbolSelect = document.getElementById('symbol-select');
            const countDiv = document.getElementById('symbol-count');
            const today = new Date().toISOString().slice(0,10);
            // 1. 检查本地缓存
            if (!force) {
                const cache = localStorage.getItem('binance_symbols_cache');
                const cacheDate = localStorage.getItem('binance_symbols_cache_date');
                if (cache && cacheDate === today) {
                    window.symbolsList = JSON.parse(cache);
                    renderSymbolSelect();
                    updateLeverageDesc();
                    return;
                }
            }
            symbolSelect.innerHTML = '<option value="">加载中...</option>';
            try {
                const response = await fetch('/api/binance_symbols');
                const data = await response.json();
                if (data.success) {
                    window.symbolsList = data.symbols || [];
                    // 写入本地缓存
                    localStorage.setItem('binance_symbols_cache', JSON.stringify(window.symbolsList));
                    localStorage.setItem('binance_symbols_cache_date', today);
                    // 获取最大杠杆
                    const levResp = await fetch('/api/symbols_with_leverage?exchange=' + document.getElementById('trade-exchange-select').value);
                    const levData = await levResp.json();
                    window.symbolLeverageMap = {};
                    if (levData.success && levData.symbols) {
                        levData.symbols.forEach(item => {
                            window.symbolLeverageMap[item.symbol] = item.maxLeverage || item.max_leverage || 125;
                        });
                    }
                    renderSymbolSelect();
                    updateLeverageDesc();
                } else {
                    showAlert('获取交易对失败: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'danger');
            }
        }
        function renderSymbolSelect() {
            const symbolSelect = document.getElementById('symbol-select');
            const countDiv = document.getElementById('symbol-count');
            let options = '<option value="">请选择交易对...</option>';
            window.symbolsList.forEach(symbol => {
                options += `<option value="${symbol}">${symbol}</option>`;
            });
            symbolSelect.innerHTML = options;
            countDiv.textContent = `共 ${window.symbolsList.length} 个交易对`;
            // 默认选择BTCUSDT
            if (window.symbolsList.includes('BTCUSDT')) {
                symbolSelect.value = 'BTCUSDT';
                onSymbolChange();
            }
        }
        
        // 交易对选择变化
        function onSymbolChange() {
            currentSymbol = document.getElementById('symbol-select').value;
            if (emaSignalTimer) {
                clearInterval(emaSignalTimer);
            }
            if (currentSymbol) {
                updateLeverageDesc();
                loadPriceInfo();
                renderTradingView(currentSymbol);
                // 分别加载4h和15m信号（首次加载显示加载中）
                loadEmaSignal(currentSymbol, '4h', 'ema-signal-panel-4h', false);
                loadEmaSignal(currentSymbol, '15m', 'ema-signal-panel-15m', false);
                // 定时刷新EMA信号（不显示加载中）
                emaSignalTimer = setInterval(() => {
                    loadEmaSignal(currentSymbol, '4h', 'ema-signal-panel-4h', true);
                    loadEmaSignal(currentSymbol, '15m', 'ema-signal-panel-15m', true);
                }, 30000);
            } else {
                hidePriceInfo();
                clearCharts();
                document.getElementById('ema-signal-panel-4h').innerHTML = '';
                document.getElementById('ema-signal-panel-15m').innerHTML = '';
            }
        }
        
        // 加载价格信息
        async function loadPriceInfo() {
            if (!currentSymbol) return;
            
            try {
                const response = await fetch(`/api/binance_ticker/${currentSymbol}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPriceInfo(data.ticker);
                } else {
                    showAlert('获取价格信息失败: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'danger');
            }
        }
        
        // 显示价格信息
        function displayPriceInfo(ticker) {
            const priceInfo = document.getElementById('price-info');
            priceInfo.style.display = 'block';
            
            // 更新价格数据
            document.getElementById('last-price').textContent = parseFloat(ticker.last_price).toFixed(2);
            
            const priceChange = parseFloat(ticker.price_change_percent);
            const priceChangeElement = document.getElementById('price-change');
            priceChangeElement.textContent = priceChange.toFixed(2) + '%';
            priceChangeElement.className = 'price-value ' + (priceChange >= 0 ? 'price-up' : 'price-down');
            
            document.getElementById('high-price').textContent = parseFloat(ticker.high_price).toFixed(2);
            document.getElementById('low-price').textContent = parseFloat(ticker.low_price).toFixed(2);
            document.getElementById('volume').textContent = parseFloat(ticker.volume).toFixed(2);
            document.getElementById('quote-volume').textContent = parseFloat(ticker.quote_volume).toFixed(2);
        }
        
        // 隐藏价格信息
        function hidePriceInfo() {
            document.getElementById('price-info').style.display = 'none';
        }
        
        // 加载K线数据（带缓存）
        async function loadKlineData(interval) {
            if (!currentSymbol) return;
            const cacheKey = `${currentSymbol}-${interval}`;
            const now = Date.now();
            if (window.klineCache[cacheKey] && now - window.klineCache[cacheKey].ts < KLINE_CACHE_TTL) {
                displayKlineChart(interval === '4h' ? 'chart-4h' : 'chart-15m', window.klineCache[cacheKey].data, interval);
                return;
            }
            const chartId = interval === '4h' ? 'chart-4h' : 'chart-15m';
            const chartElement = document.getElementById(chartId);
            try {
                const response = await fetch(`/api/binance_klines/${currentSymbol}/${interval}`);
                const data = await response.json();
                if (data.success) {
                    window.klineCache[cacheKey] = {data: data.klines, ts: now};
                    displayKlineChart(chartId, data.klines, interval);
                } else {
                    showAlert(`获取${interval}K线失败: ` + data.error, 'danger');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'danger');
            }
        }
        
        // 显示K线图表
        function displayKlineChart(chartId, klines, interval) {
            const ctx = document.getElementById(chartId).getContext('2d');
            
            // 销毁现有图表
            if (chartId === 'chart-4h' && chart4h) {
                chart4h.destroy();
            } else if (chartId === 'chart-15m' && chart15m) {
                chart15m.destroy();
            }
            
            // 准备数据
            const labels = klines.map(k => new Date(k.open_time).toLocaleString());
            const prices = klines.map(k => parseFloat(k.close));
            const volumes = klines.map(k => parseFloat(k.volume));
            
            // 创建图表
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '价格',
                        data: prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: '成交量',
                        data: volumes,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentSymbol} ${interval} K线图`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '价格 (USDT)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '成交量'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            // 保存图表引用
            if (chartId === 'chart-4h') {
                chart4h = chart;
            } else if (chartId === 'chart-15m') {
                chart15m = chart;
            }
        }
        
        // 清除图表
        function clearCharts() {
            if (chart4h) {
                chart4h.destroy();
                chart4h = null;
            }
            if (chart15m) {
                chart15m.destroy();
                chart15m = null;
            }
        }
        
        // 加载当前数据
        function loadCurrentData() {
            if (currentSymbol) {
                loadPriceInfo();
                renderTradingView(currentSymbol);
            }
        }
        
        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // 自动刷新价格信息（每30秒）
        setInterval(() => {
            if (currentSymbol) {
                loadPriceInfo();
            }
        }, 30000);
        
        // 渲染TradingView组件
        function renderTradingView(symbol) {
            document.getElementById('tv_chart_4h').innerHTML = '';
            document.getElementById('tv_chart_15m').innerHTML = '';
            new TradingView.widget({
                container_id: "tv_chart_4h",
                width: "100%",
                height: 400,
                symbol: "BINANCE:" + symbol + "PERP",
                interval: "240",
                timezone: "Asia/Shanghai",
                theme: "light",
                style: "1",
                locale: "zh_CN",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_top_toolbar: false,
                save_image: false,
                studies: [],
                withdateranges: true,
                hide_side_toolbar: false,
                allow_symbol_change: false,
                details: true,
                hotlist: false,
                calendar: false,
                studies_overrides: {},
                overrides: {},
            });
            new TradingView.widget({
                container_id: "tv_chart_15m",
                width: "100%",
                height: 400,
                symbol: "BINANCE:" + symbol + "PERP",
                interval: "15",
                timezone: "Asia/Shanghai",
                theme: "light",
                style: "1",
                locale: "zh_CN",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_top_toolbar: false,
                save_image: false,
                studies: [],
                withdateranges: true,
                hide_side_toolbar: false,
                allow_symbol_change: false,
                details: true,
                hotlist: false,
                calendar: false,
                studies_overrides: {},
                overrides: {},
            });
        }
        
        // EMA信号加载函数（带缓存）
        async function loadEmaSignal(symbol, interval, panelId, isRefresh=false) {
            const panel = document.getElementById(panelId);
            const cacheKey = `${symbol}-${interval}`;
            const now = Date.now();
            if (window.emaCache[cacheKey] && now - window.emaCache[cacheKey].ts < EMA_CACHE_TTL) {
                renderEmaSignal(panel, window.emaCache[cacheKey].data, symbol, interval);
                return;
            }
            if (!isRefresh) panel.innerHTML = '加载中...';
            try {
                const resp = await fetch(`/api/ema_signal?symbol=${symbol}&interval=${interval}`);
                const data = await resp.json();
                if (!data.success) {
                    panel.innerHTML = `<span style="color:red;">${data.error}</span>`;
                    return;
                }
                window.emaCache[cacheKey] = {data, ts: now};
                renderEmaSignal(panel, data, symbol, interval);
            } catch (e) {
                panel.innerHTML = `<span style="color:red;">请求失败: ${e}</span>`;
            }
        }
        function renderEmaSignal(panel, data, symbol, interval) {
            let html = `<b>${symbol} ${interval} EMA信号</b><br>`;
            html += `<div>最新收盘价: <b>${data.last_close}</b></div>`;
            html += `<div>时间: ${new Date(data.time).toLocaleString()}</div>`;
            html += `<div>均线: `;
            for (const [k, v] of Object.entries(data.ema)) {
                html += `<span style="margin-right:10px;">${k}: <b>${parseFloat(v).toFixed(2)}</b></span>`;
            }
            html += `</div>`;
            if (data.signal.trend) {
                html += `<div>趋势信号: <span style="color:${data.signal.trend.includes('多头') ? 'green' : data.signal.trend.includes('空头') ? 'red' : 'gray'};font-weight:bold">${data.signal.trend}</span></div>`;
            }
            if (data.signal.cross) {
                html += `<div>交叉信号: <span style="color:${data.signal.cross === '金叉' ? 'green' : data.signal.cross === '死叉' ? 'red' : 'gray'};font-weight:bold">${data.signal.cross || '无'}</span></div>`;
            }
            // 15m信号下也显示趋势判断（如有）
            if (interval === '15m' && data.trend_from_4h) {
                html += `<div>当前趋势: <span style="color:${data.trend_from_4h.includes('多头') ? 'green' : data.trend_from_4h.includes('空头') ? 'red' : 'gray'};font-weight:bold">${data.trend_from_4h}</span></div>`;
            }
            panel.innerHTML = html;
        }
    </script>
</body>
</html> 