<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .balance-item:last-child {
            border-bottom: none;
        }
        
        .balance-amount {
            font-weight: bold;
            color: #667eea;
        }
        
        .position-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .position-long {
            border-left-color: #28a745;
        }
        
        .position-short {
            border-left-color: #dc3545;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .orderbook {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .orderbook-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .orderbook-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .orderbook-table th,
        .orderbook-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        .orderbook-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
        }
        
        .asks {
            color: #dc3545;
        }
        
        .bids {
            color: #28a745;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .refresh-btn {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ äº¤æ˜“ç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§è´¦æˆ·ä½™é¢ã€æŒä»“ä¿¡æ¯ï¼Œç­–ç•¥äº¤æ˜“æ“ä½œï¼Œå¯¹åˆ·å¯¹å†²ï¼Œå¥—åˆ©æ¨¡å—</p>
        </div>
        <div style="text-align:right;margin-bottom:15px;">
            <label for="exchange-select" style="font-weight:bold;">é€‰æ‹©äº¤æ˜“æ‰€ï¼š</label>
            <select id="exchange-select" onchange="onExchangeChange()" style="padding:6px 12px;border-radius:6px;">
                <option value="aster">Aster</option>
                <option value="backpack">Backpack</option>
            </select>
            <button class="btn" style="margin-left:10px;padding:6px 12px;font-size:12px;" onclick="showCacheStatus()">ç¼“å­˜çŠ¶æ€</button>
            <button class="btn" style="margin-left:5px;padding:6px 12px;font-size:12px;" onclick="loadSymbolsWithLeverage(true)">åˆ·æ–°æ•°æ®</button>
            <button class="btn" style="margin-left:5px;padding:6px 12px;font-size:12px;" onclick="clearSymbolsCache()">æ¸…é™¤å½“å‰ç¼“å­˜</button>
            <button class="btn" style="margin-left:5px;padding:6px 12px;font-size:12px;" onclick="clearAllSymbolsCache()">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
        </div>
        
        <div class="content">
            <div class="tabs">
                <div class="tab" onclick="switchTab('overview')">è´¦æˆ·æ¦‚è§ˆ</div>
                <div class="tab" onclick="switchTab('trading')">äº¤æ˜“æ“ä½œ</div>
                <div class="tab" onclick="switchTab('hedge')">å¯¹åˆ·å¯¹å†²</div>
                <div class="tab" onclick="switchTab('arbitrage')">å¥—åˆ©æ¨¡å—</div>
                <div class="tab" onclick="window.open('/binance_charts', '_blank')">ç­–ç•¥äº¤æ˜“</div>
                <div class="tab" onclick="switchTab('orders')">è®¢å•å†å²</div>
                <div class="tab" onclick="switchTab('pnl')">ç›ˆäºå†å²</div>
            </div>
            
            <!-- è´¦æˆ·æ¦‚è§ˆ -->
            <div id="overview" class="tab-content active">
                <div class="grid">
                    <div class="card">
                        <h3>ğŸ’° è´¦æˆ·ä½™é¢</h3>
                        <div id="balance-content">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                        <button class="btn refresh-btn" onclick="loadAccountInfo()">åˆ·æ–°</button>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ“Š æŒä»“ä¿¡æ¯</h3>
                        <div id="position-content">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                        <button class="btn refresh-btn" onclick="loadAccountInfo()">åˆ·æ–°</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“ˆ å®æ—¶è®¢å•ç°¿</h3>
                    <div class="form-group">
                        <label for="orderbook-symbol">äº¤æ˜“å¯¹:</label>
                        <select id="orderbook-symbol" onchange="loadOrderbook()">
                            <option value="BTCUSDT">BTCUSDT</option>
                            <option value="ETHUSDT">ETHUSDT</option>
                            <option value="BNBUSDT">BNBUSDT</option>
                        </select>
                    </div>
                    <div id="orderbook-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <button class="btn refresh-btn" onclick="loadOrderbook()">åˆ·æ–°</button>
                </div>
            </div>
            
            <!-- äº¤æ˜“æ“ä½œ -->
            <div id="trading" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>âš™ï¸ æ æ†è®¾ç½®</h3>
                        <div class="form-group">
                            <label for="leverage-symbol">äº¤æ˜“å¯¹:</label>
                            <select id="leverage-symbol" onchange="updateLeverageMax()">
                                <option value="BTCUSDT">BTCUSDT</option>
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="BNBUSDT">BNBUSDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leverage-value">æ æ†å€æ•°:</label>
                            <input type="number" id="leverage-value" min="1" max="125" value="20">
                        </div>
                        <button class="btn" id="leverage-btn" onclick="setLeverage()">è®¾ç½®æ æ†</button>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ“ ä¸‹å•æ“ä½œ</h3>
                        <div class="form-group">
                            <label for="order-symbol">äº¤æ˜“å¯¹:</label>
                            <select id="order-symbol">
                                <option value="BTCUSDT">BTCUSDT</option>
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="BNBUSDT">BNBUSDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="order-side">æ–¹å‘:</label>
                            <select id="order-side">
                                <option value="BUY">ä¹°å…¥/åšå¤š</option>
                                <option value="SELL">å–å‡º/åšç©º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="order-type">è®¢å•ç±»å‹:</label>
                            <select id="order-type" onchange="togglePriceField()">
                                <option value="MARKET">å¸‚ä»·å•</option>
                                <option value="LIMIT">é™ä»·å•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="order-price">ä»·æ ¼ (é™ä»·å•):</label>
                            <input type="number" id="order-price" step="0.01" disabled>
                        </div>
                        <div class="form-group">
                            <label for="order-usdt-amount">USDTé‡‘é¢:</label>
                            <input type="number" id="order-usdt-amount" step="0.01" placeholder="è¾“å…¥USDTé‡‘é¢">
                        </div>
                        <div class="form-group">
                            <label for="order-quantity">æ•°é‡ (å¯é€‰):</label>
                            <input type="number" id="order-quantity" step="0.0001" placeholder="æˆ–ç›´æ¥è¾“å…¥æ•°é‡">
                        </div>
                        <button class="btn btn-success" onclick="placeOrder()">ä¸‹å•</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ”„ å¹³ä»“æ“ä½œ</h3>
                    <div class="form-group">
                        <label for="close-symbol">äº¤æ˜“å¯¹:</label>
                        <select id="close-symbol">
                            <option value="BTCUSDT">BTCUSDT</option>
                            <option value="ETHUSDT">ETHUSDT</option>
                            <option value="BNBUSDT">BNBUSDT</option>
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="closePosition()">å¸‚ä»·å¹³ä»“</button>
                </div>
            </div>
            
            <!-- è®¢å•å†å² -->
            <div id="orders" class="tab-content">
                <div class="card">
                    <h3>ğŸ“‹ è®¢å•å†å²
                        <button class="btn btn-success" style="font-size:12px;padding:4px 10px;margin-left:20px;" onclick="switchOrderHistoryType('trade')">æˆäº¤å†å²</button>
                        <button class="btn btn-info" style="font-size:12px;padding:4px 10px;" onclick="switchOrderHistoryType('order')">å§”æ‰˜å†å²</button>
                    </h3>
                    <div class="form-group">
                        <label for="history-symbol">äº¤æ˜“å¯¹:</label>
                        <select id="history-symbol" onchange="reloadOrderHistoryV2()">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div id="order-history-content-v2">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <button class="btn refresh-btn" onclick="reloadOrderHistoryV2()">åˆ·æ–°</button>
                </div>
            </div>
            <!-- ç›ˆäºå†å² -->
            <div id="pnl" class="tab-content">
                <div class="card">
                    <h3>ğŸ’¹ ç›ˆäºå†å²</h3>
                    <div class="form-group">
                        <label for="pnl-symbol">äº¤æ˜“å¯¹:</label>
                        <select id="pnl-symbol" onchange="loadPnlHistory()">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div id="pnl-history-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <button class="btn refresh-btn" onclick="loadPnlHistory()">åˆ·æ–°</button>
                </div>
            </div>
            
            <!-- å¯¹åˆ·å¯¹å†² -->
            <div id="hedge" class="tab-content">
                <div class="card">
                    <h3>ğŸ”„ å¯¹åˆ·å¯¹å†²</h3>
                    <p style="color: #666; margin-bottom: 20px;">åœ¨ä¸¤ä¸ªäº¤æ˜“æ‰€åŒæ—¶ä¸‹å•å¯¹å†²ï¼Œé™ä½é£é™©</p>
                    <div class="grid">
                        <div class="card">
                            <h4>ğŸ“ˆ äº¤æ˜“æ‰€1</h4>
                            <div class="form-group">
                                <label for="hedge-ex1">äº¤æ˜“æ‰€:</label>
                                <select id="hedge-ex1" onchange="loadHedgeSymbols(1); updateHedgeLeverageInput(1); loadHedgePosition(1);">
                                    <option value="aster">Aster</option>
                                    <option value="backpack">Backpack</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-symbol1">äº¤æ˜“å¯¹:</label>
                                <select id="hedge-symbol1" onchange="loadHedgePosition(1)"></select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-side1">æ–¹å‘:</label>
                                <select id="hedge-side1">
                                    <option value="BUY">åšå¤š</option>
                                    <option value="SELL">åšç©º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-usdt1">USDTé‡‘é¢:</label>
                                <input type="number" id="hedge-usdt1" min="1" step="any" value="150">
                            </div>
                            <div class="form-group">
                                <label for="hedge-leverage1">æ æ†å€æ•°:</label>
                                <input type="number" id="hedge-leverage1" min="1" max="125" value="50">
                            </div>
                            <div id="hedge-position1" class="hedge-position-info"></div>
                        </div>
                        <div class="card">
                            <h4>ğŸ“‰ äº¤æ˜“æ‰€2</h4>
                            <div class="form-group">
                                <label for="hedge-ex2">äº¤æ˜“æ‰€:</label>
                                <select id="hedge-ex2" onchange="loadHedgeSymbols(2); updateHedgeLeverageInput(2); loadHedgePosition(2);">
                                    <option value="aster">Aster</option>
                                    <option value="backpack">Backpack</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-symbol2">äº¤æ˜“å¯¹:</label>
                                <select id="hedge-symbol2" onchange="loadHedgePosition(2)"></select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-side2">æ–¹å‘:</label>
                                <select id="hedge-side2">
                                    <option value="BUY">åšå¤š</option>
                                    <option value="SELL">åšç©º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hedge-usdt2">USDTé‡‘é¢:</label>
                                <input type="number" id="hedge-usdt2" min="1" step="any" value="150">
                            </div>
                            <div class="form-group">
                                <label for="hedge-leverage2">æ æ†å€æ•°:</label>
                                <input type="number" id="hedge-leverage2" min="1" max="125" value="50">
                            </div>
                            <div id="hedge-position2" class="hedge-position-info"></div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 20px;">
                        <h4>âš¡ ä¸€é”®å¯¹å†²</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="hedge-sync-amount" checked> åŒæ­¥é‡‘é¢ï¼ˆäº¤æ˜“æ‰€2è‡ªåŠ¨ä½¿ç”¨ç›¸åŒé‡‘é¢ï¼‰
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="hedge-auto-symbol" checked> è‡ªåŠ¨è½¬æ¢äº¤æ˜“å¯¹æ ¼å¼
                            </label>
                        </div>
                        <button class="btn btn-success" style="font-size: 16px; padding: 15px 30px;" onclick="placeHedgeOrders()">ğŸš€ ä¸€é”®å¯¹å†²ä¸‹å•</button>
                        <button class="btn btn-danger" style="font-size: 16px; padding: 15px 30px; margin-left: 10px;" onclick="closeHedgePositions()">ğŸ›‘ ä¸€é”®å¹³ä»“</button>
                    </div>
                    <div id="hedge-result" style="margin-top: 20px;"></div>
                </div>
                <!-- æŒä»“å±•ç¤ºåŒºåŸŸï¼Œä»…å¯¹åˆ·tabä¸‹æ˜¾ç¤º -->
                <div class="card" style="margin-top: 30px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border: 2px solid #a48be0; color: #333;">
                    <h3 style="color:#4b2991; margin-bottom: 18px;">æŒä»“å±•ç¤º</h3>
                    <div style="margin-bottom: 15px;">
                        <b style="color:#4b2991;">äº¤æ˜“æ‰€1æŒä»“</b>
                        <div id="hedge-position1-show" class="hedge-position-info" style="margin-left: 20px;"></div>
                    </div>
                    <div>
                        <b style="color:#4b2991;">äº¤æ˜“æ‰€2æŒä»“</b>
                        <div id="hedge-position2-show" class="hedge-position-info" style="margin-left: 20px;"></div>
                    </div>
                </div>
            </div>
            <!-- å¥—åˆ©æ¨¡å— -->
            <div id="arbitrage" class="tab-content">
                <div class="card">
                    <h3>ğŸ’¹ å¥—åˆ©æ¨¡å—</h3>
                    <p style="color: #666; margin-bottom: 20px;">åœ¨ä¸¤ä¸ªäº¤æ˜“æ‰€åŒæ—¶ä¸‹å•å¥—åˆ©ï¼Œæ•æ‰ä»·å·®æœºä¼š</p>
                    <div class="grid">
                        <div class="card">
                            <h4>ğŸ“ˆ äº¤æ˜“æ‰€1</h4>
                            <div class="form-group">
                                <label for="arbi-ex1">äº¤æ˜“æ‰€:</label>
                                <select id="arbi-ex1" onchange="loadArbiSymbols(1); updateArbiLeverageInput(1); loadArbiPosition(1, true);">
                                    <option value="aster">Aster</option>
                                    <option value="backpack">Backpack</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="arbi-symbol1">äº¤æ˜“å¯¹:</label>
                                <select id="arbi-symbol1" onchange="loadArbiPosition(1, true)"></select>
                            </div>
                            <!-- äº¤æ˜“æ‰€1å¡ç‰‡å†…ï¼šåªä¿ç•™ä¹°1å–1ä»·æ ¼å±•ç¤ºåŒºï¼Œç§»é™¤diff1/diff2å±•ç¤ºåŒº -->
                            <div class="form-group" style="color:#d32f2f;font-weight:bold;font-size:1.1em;">
                                <span id="arbi-orderbook1">å–1ä»·æ ¼ï¼š--ã€€ä¹°1ä»·æ ¼ï¼š--</span>
                            </div>
                            <div class="form-group">
                                <label for="arbi-side1">æ–¹å‘:</label>
                                <select id="arbi-side1">
                                    <option value="BUY">åšå¤š</option>
                                    <option value="SELL">åšç©º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="arbi-usdt1">USDTé‡‘é¢:</label>
                                <input type="number" id="arbi-usdt1" min="1" step="any" value="150">
                            </div>
                            <div class="form-group">
                                <label for="arbi-leverage1">æ æ†å€æ•°:</label>
                                <input type="number" id="arbi-leverage1" min="1" max="125" value="50">
                            </div>
                            <div id="arbi-position1" class="arbi-position-info"></div>
                        </div>
                        <div class="card">
                            <h4>ğŸ“‰ äº¤æ˜“æ‰€2</h4>
                            <div class="form-group">
                                <label for="arbi-ex2">äº¤æ˜“æ‰€:</label>
                                <select id="arbi-ex2" onchange="loadArbiSymbols(2); updateArbiLeverageInput(2); loadArbiPosition(2, true);">
                                    <option value="aster">Aster</option>
                                    <option value="backpack">Backpack</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="arbi-symbol2">äº¤æ˜“å¯¹:</label>
                                <select id="arbi-symbol2" onchange="loadArbiPosition(2, true)"></select>
                            </div>
                            <!-- ä¹°1å–1ä»·æ ¼å±•ç¤ºåŒºï¼ˆä¸å†æ˜¾ç¤ºdiffï¼‰ -->
                            <div class="form-group" style="color:#d32f2f;font-weight:bold;font-size:1.1em;">
                                <span id="arbi-orderbook2">å–1ä»·æ ¼ï¼š--ã€€ä¹°1ä»·æ ¼ï¼š--</span>
                            </div>
                            <div class="form-group">
                                <label for="arbi-side2">æ–¹å‘:</label>
                                <select id="arbi-side2">
                                    <option value="BUY">åšå¤š</option>
                                    <option value="SELL">åšç©º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="arbi-usdt2">USDTé‡‘é¢:</label>
                                <input type="number" id="arbi-usdt2" min="1" step="any" value="150">
                            </div>
                            <div class="form-group">
                                <label for="arbi-leverage2">æ æ†å€æ•°:</label>
                                <input type="number" id="arbi-leverage2" min="1" max="125" value="50">
                            </div>
                            <div id="arbi-position2" class="arbi-position-info"></div>
                        </div>
                    </div>
                    <!-- ä¸€é”®å¥—åˆ©ç»„ä»¶ -->
                    <div class="card" style="margin-top:32px;">
                        <h4>âš¡ä¸€é”®å¥—åˆ©</h4>
                        <div class="form-group">
                            åŒæ­¥é‡‘é¢ï¼ˆäº¤æ˜“æ‰€2è‡ªåŠ¨ä½¿ç”¨ç›¸åŒé‡‘é¢ï¼‰
                            <input type="checkbox" id="arbi-sync-amount" checked>
                        </div>
                        <div class="form-group">
                            è‡ªåŠ¨è½¬æ¢äº¤æ˜“å¯¹æ ¼å¼
                            <input type="checkbox" id="arbi-auto-symbol" checked>
                        </div>
                        <!-- ä¸€é”®å¥—åˆ©ç»„ä»¶å†…diff1/diff2å±•ç¤ºåŒºï¼Œä¿æŒä¸å˜ -->
                        <div class="form-group" style="display:flex;align-items:center;justify-content:center;gap:32px;">
                            <div style="color:#e65100;font-weight:bold;font-size:1.1em;text-align:center;">
                                <span id="arbi-diff">diff1 = --ï¼Œdiff2 = --</span>
                            </div>
                            <div style="color:#d32f2f;font-weight:bold;font-size:1.1em;display:flex;align-items:center;">
                                ä»·å·®é˜ˆå€¼ <input id="arbi-threshold" type="number" value="50" min="0" step="0.01" style="width:70px;margin-left:6px;border:2px solid #d32f2f;border-radius:4px;font-size:1em;padding:2px 6px;">
                            </div>
                            <div style="color:#d32f2f;font-weight:bold;font-size:1.1em;display:flex;align-items:center;">
                                å¹³ä»“ä»·å·®é˜€å€¼ <input id="arbi-close-threshold" type="number" value="10" min="0" step="0.01" style="width:70px;margin-left:6px;border:2px solid #d32f2f;border-radius:4px;font-size:1em;padding:2px 6px;">
                            </div>
                            <div style="color:#d32f2f;font-weight:bold;font-size:1.1em;display:flex;align-items:center;">
                                <input id="arbi-auto-enable" type="checkbox" style="width:20px;height:20px;margin-right:6px;"> æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¥—åˆ©
                            </div>
                        </div>
                        <div class="form-group" style="text-align:center;">
                            <button class="btn btn-success" onclick="arbiOrder()">ğŸš€ä¸€é”®å¥—åˆ©ä¸‹å•</button>
                            <button class="btn btn-danger" onclick="arbiCloseAll()">ğŸ”´ä¸€é”®å¹³ä»“</button>
                        </div>
                    </div>
                    <div id="arbi-result" style="margin-top: 20px;"></div>
                </div>
                <!-- æŒä»“å±•ç¤ºåŒºåŸŸï¼Œä»…å¥—åˆ©tabä¸‹æ˜¾ç¤º -->
                <div class="card" style="margin-top: 30px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border: 2px solid #a48be0; color: #333;">
                    <h3 style="color:#4b2991; margin-bottom: 18px;">æŒä»“å±•ç¤º</h3>
                    <div style="margin-bottom: 15px;">
                        <b style="color:#4b2991;">äº¤æ˜“æ‰€1æŒä»“</b>
                        <div id="arbi-position1-show" class="arbi-position-info" style="margin-left: 20px;"></div>
                    </div>
                    <div>
                        <b style="color:#4b2991;">äº¤æ˜“æ‰€2æŒä»“</b>
                        <div id="arbi-position2-show" class="arbi-position-info" style="margin-left: 20px;"></div>
                    </div>
                </div>
            </div>
            <!-- EMAéš§é“ -->
            <div id="ema-tunnel" class="tab-content">
                <div class="card">
                    <h3>ğŸ“ˆ EMAéš§é“</h3>
                    <div class="form-group">
                        <span style="color:#888;font-size:1.2em;">ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾å°†äºæ–°çª—å£æ‰“å¼€EMAéš§é“å›¾è¡¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç¼“å­˜äº¤æ˜“å¯¹åŠæœ€å¤§æ æ†
        let symbolLeverageMap = {};
        let symbolsList = [];
        let currentExchange = localStorage.getItem('exchange') || 'aster';

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®å’Œäº¤æ˜“å¯¹
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('exchange-select').value = currentExchange;
            
            // å»¶è¿Ÿæ˜¾ç¤ºç¼“å­˜çŠ¶æ€ï¼Œé¿å…ä¸åŠ è½½çŠ¶æ€å†²çª
            setTimeout(() => {
                showCacheStatus();
            }, 2000);
            
            loadSymbolsWithLeverage().then(() => {
            loadAccountInfo();
            loadOrderbook();
            loadOrderHistory();
            });
            // åˆ·æ–°å¯¹åˆ·tabçš„äº¤æ˜“å¯¹ä¸‹æ‹‰æ¡†ï¼Œå¿…é¡»å…ˆè®¾ç½®äº¤æ˜“æ‰€é»˜è®¤å€¼å†åŠ è½½symbols
            document.getElementById('hedge-ex1').value = 'aster';
            document.getElementById('hedge-ex2').value = 'backpack';
            document.getElementById('hedge-side1').value = 'BUY';
            document.getElementById('hedge-side2').value = 'SELL';
            document.getElementById('hedge-usdt1').value = 150;
            document.getElementById('hedge-usdt2').value = 150;
            // å…ˆè®¾ç½®äº¤æ˜“æ‰€ï¼Œå†åˆ†åˆ«åŠ è½½symbolsï¼Œä¿è¯æ•°æ®æºæ­£ç¡®
            loadHedgeSymbols(1);
            loadHedgeSymbols(2);
            loadHedgePosition(1);
            loadHedgePosition(2);
            updateLeverageUI();
            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¿€æ´»ä¸Šæ¬¡tab
            const lastTab = localStorage.getItem('activeTab') || 'overview';
            // è§¦å‘ä¸€æ¬¡tabåˆ‡æ¢
            const tabBtn = Array.from(document.querySelectorAll('.tab')).find(tab => tab.textContent.includes(
                lastTab === 'overview' ? 'è´¦æˆ·æ¦‚è§ˆ' :
                lastTab === 'trading' ? 'äº¤æ˜“æ“ä½œ' :
                lastTab === 'hedge' ? 'å¯¹åˆ·å¯¹å†²' :
                lastTab === 'orders' ? 'è®¢å•å†å²' :
                lastTab === 'pnl' ? 'ç›ˆäºå†å²' : ''
            ));
            if (tabBtn) tabBtn.click();
            // é¡µé¢åŠ è½½æ—¶æ¢å¤arbi_open_diff_type
            window.arbi_open_diff_type = localStorage.getItem('arbi_open_diff_type');
        });

        // ç»Ÿä¸€è·å–symbolå­—ç¬¦ä¸²ï¼Œå…¼å®¹å¤šç§ç»“æ„
        function getSymbolStr(s) {
            if (typeof s === 'string') return s;
            if (s && typeof s.symbol === 'string') return s.symbol;
            if (s && s.symbol && typeof s.symbol.symbol === 'string') return s.symbol.symbol;
            return '';
        }

        function filterBackpackPerpSymbols(symbols) {
            return symbols.filter(s => {
                const symbolStr = getSymbolStr(s);
                return typeof symbolStr === 'string' && symbolStr.endsWith('_USDC_PERP');
            });
        }

        async function loadSymbolsWithLeverage(forceRefresh = false) {
            const cacheKey = 'symbols_with_leverage_' + currentExchange;
            const cacheExpireKey = 'symbols_with_leverage_expire_' + currentExchange;
            const cacheTimeKey = 'symbols_with_leverage_time_' + currentExchange;
            const expireMs = 24 * 60 * 60 * 1000; // 24å°æ—¶ç¼“å­˜æ—¶é—´
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆåªåœ¨å¼ºåˆ¶åˆ·æ–°æ—¶æ˜¾ç¤ºï¼‰
            if (forceRefresh) {
                showAlert('æ­£åœ¨åˆ·æ–°äº¤æ˜“å¯¹åˆ—è¡¨...', 'info');
            }
            
            if (!forceRefresh) {
                const cache = localStorage.getItem(cacheKey);
                const expire = localStorage.getItem(cacheExpireKey);
                
                if (cache && expire && Date.now() < parseInt(expire)) {
                    try {
                        const data = JSON.parse(cache);
                        symbolsList = data.symbols;
                        if (currentExchange === 'backpack') {
                            symbolsList = filterBackpackPerpSymbols(symbolsList);
                        }
                        symbolLeverageMap = {};
                        symbolsList.forEach(item => {
                            symbolLeverageMap[getSymbolStr(item)] = item.maxLeverage;
                        });
                        updateSymbolDropdowns();
                        
                        // é™é»˜åŠ è½½ï¼Œä¸æ˜¾ç¤ºæç¤º
                        return Promise.resolve();
                    } catch (e) {
                        console.warn('ç¼“å­˜è§£æå¤±è´¥ï¼Œé‡æ–°è·å–æ•°æ®:', e);
                    }
                }
            }
            
            try {
                const response = await fetch(`/api/symbols_with_leverage?exchange=${currentExchange}`);
                const data = await response.json();
                if (data.success) {
                    symbolsList = data.symbols;
                    if (currentExchange === 'backpack') {
                        symbolsList = filterBackpackPerpSymbols(symbolsList);
                    }
                    symbolLeverageMap = {};
                    symbolsList.forEach(item => {
                        symbolLeverageMap[getSymbolStr(item)] = item.maxLeverage;
                    });
                    
                    // ä¿å­˜åˆ°ç¼“å­˜
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    localStorage.setItem(cacheExpireKey, (Date.now() + expireMs).toString());
                    localStorage.setItem(cacheTimeKey, Date.now().toString());
                    
                    updateSymbolDropdowns();
                    if (forceRefresh) {
                        showAlert(`å·²æ›´æ–°äº¤æ˜“å¯¹åˆ—è¡¨ (${currentExchange})ï¼Œå…±${symbolsList.length}ä¸ªäº¤æ˜“å¯¹`, 'success');
                    }
                } else {
                    showAlert('è·å–äº¤æ˜“å¯¹å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (e) {
                showAlert('è·å–äº¤æ˜“å¯¹å¤±è´¥: ' + e.message, 'danger');
            }
        }

        // æ¸…é™¤å½“å‰äº¤æ˜“æ‰€çš„ç¼“å­˜
        function clearSymbolsCache() {
            const cacheKey = 'symbols_with_leverage_' + currentExchange;
            const cacheExpireKey = 'symbols_with_leverage_expire_' + currentExchange;
            const cacheTimeKey = 'symbols_with_leverage_time_' + currentExchange;
            
            localStorage.removeItem(cacheKey);
            localStorage.removeItem(cacheExpireKey);
            localStorage.removeItem(cacheTimeKey);
            
            showAlert(`å·²æ¸…é™¤ ${currentExchange} çš„äº¤æ˜“å¯¹ç¼“å­˜`, 'info');
        }
        
        // æ¸…é™¤æ‰€æœ‰äº¤æ˜“æ‰€çš„ç¼“å­˜
        function clearAllSymbolsCache() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('symbols_with_leverage_')) {
                    localStorage.removeItem(key);
                }
            });
            
            showAlert('å·²æ¸…é™¤æ‰€æœ‰äº¤æ˜“æ‰€çš„äº¤æ˜“å¯¹ç¼“å­˜', 'info');
        }
        
        // æ˜¾ç¤ºå½“å‰äº¤æ˜“æ‰€çš„ç¼“å­˜çŠ¶æ€
        function showCacheStatus() {
            const exchanges = ['aster', 'backpack'];
            let statusText = '';
            
            exchanges.forEach(exchange => {
                const cacheKey = 'symbols_with_leverage_' + exchange;
                const cacheExpireKey = 'symbols_with_leverage_expire_' + exchange;
                const cacheTimeKey = 'symbols_with_leverage_time_' + exchange;
                
                const cache = localStorage.getItem(cacheKey);
                const expire = localStorage.getItem(cacheExpireKey);
                const cacheTime = localStorage.getItem(cacheTimeKey);
                
                if (cache && expire && cacheTime) {
                    const expireTime = parseInt(expire);
                    const cacheTimeInt = parseInt(cacheTime);
                    const now = Date.now();
                    const isExpired = now > expireTime;
                    const cacheTimeStr = new Date(cacheTimeInt).toLocaleString();
                    const remainingTime = Math.floor((expireTime - now) / 1000 / 60); // å‰©ä½™åˆ†é’Ÿæ•°
                    
                    if (isExpired) {
                        statusText += `${exchange}: ç¼“å­˜å·²è¿‡æœŸ\n`;
                    } else {
                        statusText += `${exchange}: æœ‰æ•ˆç¼“å­˜ï¼Œå‰©ä½™${remainingTime}åˆ†é’Ÿ (${cacheTimeStr})\n`;
                    }
                } else {
                    statusText += `${exchange}: æš‚æ— ç¼“å­˜æ•°æ®\n`;
                }
            });
            
            showAlert(`ç¼“å­˜çŠ¶æ€:\n${statusText}`, 'info');
        }

        function updateSymbolDropdowns() {
            const selects = [
                'leverage-symbol', 'order-symbol', 'close-symbol', 'history-symbol', 'orderbook-symbol', 'pnl-symbol'
            ];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const cur = sel.value;
                // å…ˆæ’å…¥"å…¨éƒ¨"é€‰é¡¹
                let options = '<option value="">å…¨éƒ¨</option>';
                options += symbolsList.map(s => {
                    let symbolStr = getSymbolStr(s);
                    if(currentExchange === 'backpack' && symbolStr) {
                        symbolStr = symbolStr.replace(/-/g, '_');
                    }
                    return typeof symbolStr === 'string' ? `<option value="${symbolStr}">${symbolStr}</option>` : '';
                }).join('');
                sel.innerHTML = options;
                // é»˜è®¤é€‰ä¸­"å…¨éƒ¨"
                sel.value = '';
                // æ¢å¤åŸæœ‰é€‰ä¸­
                if (cur && symbolsList.some(s => {
                    let symbolStr = getSymbolStr(s);
                    if(currentExchange === 'backpack' && symbolStr) symbolStr = symbolStr.replace(/-/g, '_');
                    return symbolStr === cur;
                })) sel.value = cur;
            });
            updateLeverageMax();
        }

        // ç›‘å¬äº¤æ˜“æ‰€åˆ‡æ¢ï¼ŒåŠ¨æ€ç¦ç”¨/å¯ç”¨æ æ†è¾“å…¥æ¡†å’ŒæŒ‰é’®
        function updateLeverageUI() {
            const input = document.getElementById('leverage-value');
            const btn = document.getElementById('leverage-btn');
            const tip = document.getElementById('leverage-max-tip');
            if (currentExchange === 'backpack') {
                input.value = 1;
                input.disabled = true;
                btn.disabled = true;
                if (tip) tip.textContent = 'æœ€å¤§å¯ç”¨æ æ†ï¼š50å€ï¼ˆBackpackå›ºå®šï¼‰';
            } else {
                input.disabled = false;
                btn.disabled = false;
                updateLeverageMax();
            }
        }

        function updateLeverageMax() {
            const symbol = document.getElementById('leverage-symbol').value;
            const max = symbolLeverageMap[symbol] || 125;
            const input = document.getElementById('leverage-value');
            input.max = max;
            // æ˜¾ç¤ºæœ€å¤§æ æ†æç¤º
            let tip = document.getElementById('leverage-max-tip');
            if (!tip) {
                tip = document.createElement('div');
                tip.id = 'leverage-max-tip';
                tip.style = 'color:#888;font-size:13px;margin-top:5px;';
                input.parentNode.appendChild(tip);
            }
            if (currentExchange === 'backpack') {
                tip.textContent = `æœ€å¤§å¯ç”¨æ æ†ï¼š50å€ï¼ˆBackpackå›ºå®šï¼‰`;
            } else {
            tip.textContent = `æœ€å¤§å¯ç”¨æ æ†ï¼š${max}å€`;
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            // è®°å½•å½“å‰tabåˆ°localStorage
            localStorage.setItem('activeTab', tabName);
        }

        // åŠ è½½è´¦æˆ·ä¿¡æ¯
        async function loadAccountInfo() {
            try {
                const response = await fetch(`/api/account?exchange=${currentExchange}`);
                const data = await response.json();
                
                if (data.success) {
                    displayBalance(data.account);
                    displayPositions(data.positions);
                } else {
                    showAlert('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ˜¾ç¤ºä½™é¢ä¿¡æ¯
        function displayBalance(account) {
            const balanceContent = document.getElementById('balance-content');
            let html = '';
            let mainAsset = null;
            let mainAmount = null;
            // ä¼˜å…ˆUSDTï¼Œå…¶æ¬¡USDCï¼Œå¦åˆ™ç¬¬ä¸€ä¸ªå¸ç§
            let usdt = account.assets.find(a => a.asset === 'USDT');
            let usdc = account.assets.find(a => a.asset === 'USDC');
            if (usdt) {
                mainAsset = 'USDT';
                mainAmount = usdt.walletBalance;
            } else if (usdc) {
                mainAsset = 'USDC';
                mainAmount = usdc.walletBalance;
            } else if (account.assets.length > 0) {
                mainAsset = account.assets[0].asset;
                mainAmount = account.assets[0].walletBalance;
            }
            if (mainAsset) {
                html += `<div class="balance-item"><span>${mainAsset}</span><span class="balance-amount">${parseFloat(mainAmount).toFixed(6)}</span></div>`;
            }
            // ä½™é¢åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰å¸ç§
            account.assets.forEach(asset => {
                if (!mainAsset || asset.asset !== mainAsset) {
                    if (parseFloat(asset.walletBalance) > 0) {
                        html += `<div class="balance-item"><span>${asset.asset}</span><span class="balance-amount">${parseFloat(asset.walletBalance).toFixed(6)}</span></div>`;
                    }
                }
            });
            balanceContent.innerHTML = html || '<div class="loading">æš‚æ— ä½™é¢</div>';
        }

        // æ˜¾ç¤ºæŒä»“ä¿¡æ¯
        function displayPositions(positions) {
            const positionContent = document.getElementById('position-content');
            let html = '';
            positions.forEach(position => {
                // å…¼å®¹å¤šç§å­—æ®µ
                const positionAmt = parseFloat(position.positionAmt ?? position.position_amt ?? position.netQuantity ?? 0);
                if (positionAmt !== 0) {
                    // ä¼˜å…ˆå…¼å®¹Backpackçš„pnlUnrealized
                    let pnlRaw = position.pnlUnrealized ?? position.unrealizedProfit ?? position.unrealizedPnl ?? position.unrealized_profit ?? 0;
                    const pnl = parseFloat(pnlRaw);
                    const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
                    const positionClass = positionAmt > 0 ? 'position-long' : 'position-short';
                    html += `
                        <div class="position-item ${positionClass}">
                            <div><strong>${position.symbol}</strong></div>
                            <div>æŒä»“é‡: ${positionAmt.toFixed(4)}</div>
                            <div>å¼€ä»“ä»·: ${parseFloat(position.entryPrice ?? position.entry_price ?? 0).toFixed(2)}</div>
                            <div>æœªå®ç°ç›ˆäº: <span class="${pnlClass}">${isNaN(pnl) ? '--' : pnl.toFixed(2)} USDT</span></div>
                            <button class="btn btn-danger" style="float:right;margin-top:10px;" onclick="closePositionBySymbol('${position.symbol}')">å¸‚ä»·å¹³ä»“</button>
                        </div>
                    `;
                }
            });
            positionContent.innerHTML = html || '<div class="loading">æš‚æ— æŒä»“</div>';
        }

        // æ–°å¢ï¼šæ”¯æŒç›´æ¥å¹³ä»“
        async function closePositionBySymbol(symbol) {
            if (!confirm(`ç¡®å®šè¦å¸‚ä»·å¹³ä»“ ${symbol} çš„æ‰€æœ‰æŒä»“å—ï¼Ÿ`)) {
                return;
            }
            try {
                const response = await fetch('/api/close_position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, exchange: currentExchange })
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('å¹³ä»“æˆåŠŸï¼', 'success');
                    loadAccountInfo();
                } else {
                    showAlert('å¹³ä»“å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åŠ è½½è®¢å•ç°¿
        async function loadOrderbook() {
            const symbol = document.getElementById('orderbook-symbol').value;
            const orderbookContent = document.getElementById('orderbook-content');
            
            try {
                const response = await fetch(`/api/orderbook/${symbol}?exchange=${currentExchange}`);
                const data = await response.json();
                
                if (data.success) {
                    displayOrderbook(data.orderbook);
                } else {
                    orderbookContent.innerHTML = '<div class="alert alert-danger">åŠ è½½è®¢å•ç°¿å¤±è´¥: ' + data.error + '</div>';
                }
            } catch (error) {
                orderbookContent.innerHTML = '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯: ' + error.message + '</div>';
            }
        }

        // æ˜¾ç¤ºè®¢å•ç°¿
        function displayOrderbook(orderbook) {
            const orderbookContent = document.getElementById('orderbook-content');
            
            let html = `
                <div class="orderbook">
                    <div class="orderbook-header">å®æ—¶è®¢å•ç°¿</div>
                    <table class="orderbook-table">
                        <thead>
                            <tr>
                                <th>ä»·æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>ç´¯è®¡</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // å–å•ï¼ˆasksï¼‰
            const asks = orderbook.asks.slice(0, 10).reverse();
            asks.forEach(ask => {
                html += `
                    <tr class="asks">
                        <td>${parseFloat(ask[0]).toFixed(2)}</td>
                        <td>${parseFloat(ask[1]).toFixed(4)}</td>
                        <td>${parseFloat(ask[1]).toFixed(4)}</td>
                    </tr>
                `;
            });
            
            html += '<tr><td colspan="3" style="text-align: center; background: #f8f9fa; font-weight: bold;">---</td></tr>';
            
            // ä¹°å•ï¼ˆbidsï¼‰
            const bids = orderbook.bids.slice(0, 10);
            bids.forEach(bid => {
                html += `
                    <tr class="bids">
                        <td>${parseFloat(bid[0]).toFixed(2)}</td>
                        <td>${parseFloat(bid[1]).toFixed(4)}</td>
                        <td>${parseFloat(bid[1]).toFixed(4)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            orderbookContent.innerHTML = html;
        }

        // è®¾ç½®æ æ†
        async function setLeverage() {
            const symbol = document.getElementById('leverage-symbol').value;
            const leverage = document.getElementById('leverage-value').value;
            try {
                const response = await fetch('/api/leverage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, leverage: parseInt(leverage), exchange: currentExchange })
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('æ æ†è®¾ç½®æˆåŠŸï¼', 'success');
                    // ç¼“å­˜æœ¬æ¬¡æ æ†è®¾ç½®
                    const cacheKey = `leverage_${symbol}`;
                    localStorage.setItem(cacheKey, leverage);
                } else {
                    showAlert('æ æ†è®¾ç½®å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // ä¸‹å•
        async function placeOrder() {
            const symbol = document.getElementById('order-symbol').value;
            const side = document.getElementById('order-side').value;
            const orderType = document.getElementById('order-type').value;
            const price = document.getElementById('order-price').value;
            const usdtAmount = document.getElementById('order-usdt-amount').value;
            const quantity = document.getElementById('order-quantity').value;
            if (!usdtAmount && !quantity) {
                showAlert('è¯·è¾“å…¥USDTé‡‘é¢æˆ–æ•°é‡', 'danger');
                return;
            }
            let orderData = {
                symbol,
                side,
                type: orderType,
                exchange: currentExchange
            };
            if (currentExchange === 'backpack') {
                // Backpackåªæ”¯æŒquoteQuantityï¼ˆUSDTé‡‘é¢ï¼‰ï¼Œä¸ä¼ leverage
                if (usdtAmount) orderData.quoteQuantity = usdtAmount;
                if (quantity) orderData.quantity = quantity;
                if (orderType === 'LIMIT' && price) orderData.price = price;
            } else {
                // å…¶ä»–äº¤æ˜“æ‰€åŸæœ‰å‚æ•°
                orderData.usdt_amount = usdtAmount || null;
                orderData.quantity = quantity || null;
                orderData.price = price || null;
            }
            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('ä¸‹å•æˆåŠŸï¼è®¢å•ID: ' + data.result.orderId, 'success');
                    document.getElementById('order-usdt-amount').value = '';
                    document.getElementById('order-quantity').value = '';
                    document.getElementById('order-price').value = '';
                    loadAccountInfo();
                } else {
                    showAlert('ä¸‹å•å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // å¹³ä»“
        async function closePosition() {
            const symbol = document.getElementById('close-symbol').value;
            
            if (!confirm(`ç¡®å®šè¦å¹³ä»“ ${symbol} çš„æ‰€æœ‰æŒä»“å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/close_position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, exchange: currentExchange })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('å¹³ä»“æˆåŠŸï¼', 'success');
                    loadAccountInfo();
                } else {
                    showAlert('å¹³ä»“å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ–°å¢ï¼šè®¢å•å†å²tabåˆ‡æ¢
        let orderHistoryType = 'trade'; // trade:æˆäº¤å†å², order:å§”æ‰˜å†å²
        function switchOrderHistoryType(type) {
            orderHistoryType = type;
            reloadOrderHistoryV2();
        }
        function reloadOrderHistoryV2() {
            if(orderHistoryType === 'trade') {
                loadOrderHistory();
            } else {
                loadOrderHistoryV2();
            }
        }
        // æ–°å¢ï¼šåŠ è½½å§”æ‰˜å†å²
        async function loadOrderHistoryV2() {
            const content = document.getElementById('order-history-content-v2');
            const symbol = document.getElementById('history-symbol').value;
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const url = `/api/order_history?exchange=${currentExchange}&symbol=${symbol}`;
                const resp = await fetch(url);
                const data = await resp.json();
                if(data.success) {
                    displayOrderHistoryV2(data.orders);
                } else {
                    content.innerHTML = `<div class='alert alert-danger'>åŠ è½½å§”æ‰˜å†å²å¤±è´¥: ${data.error}</div>`;
                }
            } catch(e) {
                content.innerHTML = `<div class='alert alert-danger'>ç½‘ç»œé”™è¯¯: ${e.message}</div>`;
            }
        }
        function displayOrderHistoryV2(orders) {
            const content = document.getElementById('order-history-content-v2');
            if(!orders || orders.length === 0) {
                content.innerHTML = '<div class="loading">æš‚æ— å§”æ‰˜è®°å½•</div>';
                return;
            }
            let html = `<table class="orderbook-table"><thead><tr><th>æ—¶é—´</th><th>äº¤æ˜“å¯¹</th><th>æ–¹å‘</th><th>ç±»å‹</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>çŠ¶æ€</th></tr></thead><tbody>`;
            orders.forEach(o => {
                const time = o.createdAt ? new Date(o.createdAt).toLocaleString() : '--';
                html += `<tr><td>${time}</td><td>${o.symbol||o.symbolId||'--'}</td><td>${o.side||'--'}</td><td>${o.orderType||'--'}</td><td>${o.price||'--'}</td><td>${o.quantity||o.executedQuantity||'--'}</td><td>${o.status||'--'}</td></tr>`;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        }
        // æ–°å¢ï¼šåŠ è½½ç›ˆäºå†å²
        async function loadPnlHistory() {
            const content = document.getElementById('pnl-history-content');
            const symbol = document.getElementById('pnl-symbol').value;
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const url = `/api/pnl_history?exchange=${currentExchange}&symbol=${symbol}`;
                const resp = await fetch(url);
                const data = await resp.json();
                if(data.success) {
                    displayPnlHistory(data.pnl);
                } else {
                    content.innerHTML = `<div class='alert alert-danger'>åŠ è½½ç›ˆäºå†å²å¤±è´¥: ${data.error}</div>`;
                }
            } catch(e) {
                content.innerHTML = `<div class='alert alert-danger'>ç½‘ç»œé”™è¯¯: ${e.message}</div>`;
            }
        }
        function displayPnlHistory(pnls) {
            const content = document.getElementById('pnl-history-content');
            if(!pnls || pnls.length === 0) {
                content.innerHTML = '<div class="loading">æš‚æ— ç›ˆäºè®°å½•</div>';
                return;
            }
            let html = `<table class="orderbook-table"><thead><tr><th>æ—¶é—´</th><th>äº¤æ˜“å¯¹</th><th>å·²å®ç°ç›ˆäº</th></tr></thead><tbody>`;
            pnls.forEach(p => {
                const time = p.timestamp ? new Date(p.timestamp).toLocaleString() : '--';
                html += `<tr><td>${time}</td><td>${p.symbol||'--'}</td><td>${p.pnlRealized||'--'}</td></tr>`;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        // åˆ‡æ¢ä»·æ ¼å­—æ®µ
        function togglePriceField() {
            const orderType = document.getElementById('order-type').value;
            const priceField = document.getElementById('order-price');
            
            if (orderType === 'LIMIT') {
                priceField.disabled = false;
                priceField.required = true;
            } else {
                priceField.disabled = true;
                priceField.required = false;
                priceField.value = '';
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // è‡ªåŠ¨åˆ·æ–°
        setInterval(() => {
            if (document.getElementById('overview').classList.contains('active')) {
                loadAccountInfo();
                loadOrderbook();
            }
        }, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡

        function onExchangeChange() {
            currentExchange = document.getElementById('exchange-select').value;
            localStorage.setItem('exchange', currentExchange);
            loadSymbolsWithLeverage(false); // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œä¸å¼ºåˆ¶åˆ·æ–°
            loadAccountInfo();
            loadOrderbook();
            loadOrderHistory();
            updateLeverageUI();
        }

        // ä¿®æ”¹ï¼šè®©æˆäº¤å†å²æ¸²æŸ“åˆ°order-history-content-v2
        async function loadOrderHistory() {
            const content = document.getElementById('order-history-content-v2');
            const symbol = document.getElementById('history-symbol').value;
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch(`/api/user_trades?symbol=${symbol}&exchange=${currentExchange}`);
                const data = await response.json();
                if (data.success) {
                    displayOrderHistory(data.trades);
                } else {
                    content.innerHTML = '<div class="alert alert-danger">åŠ è½½æˆäº¤å†å²å¤±è´¥: ' + data.error + '</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯: ' + error.message + '</div>';
            }
        }
        function displayOrderHistory(trades) {
            const content = document.getElementById('order-history-content-v2');
            if (!trades || trades.length === 0) {
                content.innerHTML = '<div class="loading">æš‚æ— æˆäº¤è®°å½•</div>';
                return;
            }
            // 1. æ—¶é—´å€’åºæ’åº
            trades.sort((a, b) => b.time - a.time);
            let html = `
                <table class="orderbook-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>äº¤æ˜“å¯¹</th>
                            <th>æ–¹å‘</th>
                            <th>æŒä»“æ–¹å‘</th>
                            <th>ä»·æ ¼</th>
                            <th>USDTæˆäº¤é¢</th>
                            <th>åˆ©æ¶¦</th>
                            <th>è´¹ç”¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            trades.forEach(trade => {
                const time = new Date(trade.time).toLocaleString();
                const sideClass = trade.side === 'BUY' ? 'bids' : 'asks';
                let profit = '--';
                if (trade.realizedPnl !== undefined && trade.realizedPnl !== null && trade.realizedPnl !== '' && !isNaN(parseFloat(trade.realizedPnl))) {
                    profit = parseFloat(trade.realizedPnl).toFixed(4);
                }
                // 2. è´¹ç”¨åˆ—
                let commission = '--';
                if (trade.commission !== undefined && trade.commission !== null) {
                    commission = trade.commission + (trade.commissionAsset ? (' ' + trade.commissionAsset) : '');
                }
                // 3. æ•°é‡åˆ—æ˜¾ç¤ºUSDTæˆäº¤é¢
                let quoteQty = '--';
                if (trade.quoteQty !== undefined && trade.quoteQty !== null && !isNaN(parseFloat(trade.quoteQty))) {
                    quoteQty = parseFloat(trade.quoteQty).toFixed(4);
                }
                html += `
                    <tr class="${sideClass}">
                        <td>${time}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.side}</td>
                        <td>${trade.positionSide || '--'}</td>
                        <td>${parseFloat(trade.price).toFixed(2)}</td>
                        <td title="åŸå§‹æ•°é‡: ${trade.qty}">${quoteQty}</td>
                        <td>${profit}</td>
                        <td>${commission}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        }
        
        // å¯¹åˆ·å¯¹å†²ç›¸å…³å‡½æ•°
        async function placeHedgeOrders() {
            const resultDiv = document.getElementById('hedge-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æ‰§è¡Œå¯¹å†²ä¸‹å•...</div>';
            
            // è·å–äº¤æ˜“æ‰€1å‚æ•°
            const ex1 = document.getElementById('hedge-ex1').value;
            const symbol1 = document.getElementById('hedge-symbol1').value;
            const side1 = document.getElementById('hedge-side1').value;
            const usdt1 = document.getElementById('hedge-usdt1').value;
            const lev1 = document.getElementById('hedge-leverage1').value;
            // è·å–äº¤æ˜“æ‰€2å‚æ•°
            const ex2 = document.getElementById('hedge-ex2').value;
            const symbol2 = document.getElementById('hedge-symbol2').value;
            const side2 = document.getElementById('hedge-side2').value;
            const usdt2 = document.getElementById('hedge-usdt2').value;
            const lev2 = document.getElementById('hedge-leverage2').value;
            // æ ¡éªŒ
            if (!symbol1 || !symbol2) {
                resultDiv.innerHTML = '<span style="color:red">è¯·é€‰æ‹©ä¸¤ä¸ªäº¤æ˜“æ‰€çš„äº¤æ˜“å¯¹</span>';
                return;
            }
            // å¹¶å‘è¯·æ±‚
            const [asterResult, backpackResult] = await Promise.allSettled([
                fetch('/api/hedge_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exchange: ex1,
                        symbol: symbol1, // ç›´æ¥ç”¨ä¸‹æ‹‰æ¡†é€‰ä¸­çš„symbol
                        side: side1,
                        usdt_amount: usdt1,
                        leverage: lev1
                    })
                }).then(r => r.json()),
                fetch('/api/hedge_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exchange: ex2,
                        symbol: symbol2, // ç›´æ¥ç”¨ä¸‹æ‹‰æ¡†é€‰ä¸­çš„symbol
                        side: side2,
                        usdt_amount: usdt2,
                        leverage: lev2
                    })
                }).then(r => r.json())
            ]);
            
            let html = '';
            if (asterResult.status === 'fulfilled') {
                html += `<div><b>äº¤æ˜“æ‰€1(${ex1}):</b> ${asterResult.value.success ? 'ä¸‹å•æˆåŠŸ' : 'å¤±è´¥: ' + asterResult.value.error}</div>`;
            } else {
                html += `<div><b>äº¤æ˜“æ‰€1(${ex1}):</b> å¤±è´¥: ${asterResult.reason.message}</div>`;
            }
            
            if (backpackResult.status === 'fulfilled') {
                html += `<div><b>äº¤æ˜“æ‰€2(${ex2}):</b> ${backpackResult.value.success ? 'ä¸‹å•æˆåŠŸ' : 'å¤±è´¥: ' + backpackResult.value.error}</div>`;
            } else {
                html += `<div><b>äº¤æ˜“æ‰€2(${ex2}):</b> å¤±è´¥: ${backpackResult.reason.message}</div>`;
            }
            
            resultDiv.innerHTML = html;
            // ä¸‹å•åè‡ªåŠ¨åˆ·æ–°æŒä»“å±•ç¤º
            loadHedgePosition(1);
            loadHedgePosition(2);
        }
        
        async function executeHedgeOrders(params) {
            const resultDiv = document.getElementById('hedge-result');
            let results = { aster: null, backpack: null };
            
            try {
                // å¹¶è¡Œæ‰§è¡Œä¸¤ä¸ªäº¤æ˜“æ‰€çš„ä¸‹å•
                const [asterResult, backpackResult] = await Promise.allSettled([
                    placeOrderOnExchange('aster', params.aster),
                    placeOrderOnExchange('backpack', params.backpack)
                ]);
                
                // å¤„ç†ç»“æœ
                if (asterResult.status === 'fulfilled') {
                    results.aster = asterResult.value;
                } else {
                    results.aster = { error: asterResult.reason };
                }
                
                if (backpackResult.status === 'fulfilled') {
                    results.backpack = backpackResult.value;
                } else {
                    results.backpack = { error: backpackResult.reason };
                }
                
                // æ˜¾ç¤ºç»“æœ
                displayHedgeResults(results);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">å¯¹å†²ä¸‹å•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function placeOrderOnExchange(exchange, params) {
            const response = await fetch('/api/hedge_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exchange: exchange,
                    ...params
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error);
            }
            return data.result;
        }
        
        function displayHedgeResults(results) {
            const resultDiv = document.getElementById('hedge-result');
            let html = '<div class="card"><h4>å¯¹å†²ä¸‹å•ç»“æœ</h4>';
            
            // Asterç»“æœ
            html += '<div style="margin-bottom: 15px;"><strong>Asteräº¤æ˜“æ‰€:</strong>';
            if (results.aster.error) {
                html += `<div class="alert alert-danger">å¤±è´¥: ${results.aster.error}</div>`;
            } else {
                html += `<div class="alert alert-success">æˆåŠŸ: è®¢å•ID ${results.aster.orderId || 'N/A'}</div>`;
            }
            html += '</div>';
            
            // Backpackç»“æœ
            html += '<div style="margin-bottom: 15px;"><strong>Backpackäº¤æ˜“æ‰€:</strong>';
            if (results.backpack.error) {
                html += `<div class="alert alert-danger">å¤±è´¥: ${results.backpack.error}</div>`;
            } else {
                html += `<div class="alert alert-success">æˆåŠŸ: è®¢å•ID ${results.backpack.orderId || 'N/A'}</div>`;
            }
            html += '</div>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }
        
        async function closeHedgePositions() {
            const resultDiv = document.getElementById('hedge-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æ‰§è¡Œå¯¹å†²å¹³ä»“...</div>';
            
            const asterSymbol = document.getElementById('hedge-symbol1').value;
            const backpackSymbol = document.getElementById('hedge-symbol2').value;
            // ç›´æ¥ç”¨ä¸‹æ‹‰æ¡†é€‰ä¸­çš„symbolï¼Œä¸åšè‡ªåŠ¨è½¬æ¢
            try {
                const [asterResult, backpackResult] = await Promise.allSettled([
                    closePositionOnExchange('aster', asterSymbol),
                    closePositionOnExchange('backpack', backpackSymbol)
                ]);
                
                let results = { aster: null, backpack: null };
                
                if (asterResult.status === 'fulfilled') {
                    results.aster = asterResult.value;
                } else {
                    results.aster = { error: asterResult.reason };
                }
                
                if (backpackResult.status === 'fulfilled') {
                    results.backpack = backpackResult.value;
                } else {
                    results.backpack = { error: backpackResult.reason };
                }
                
                displayHedgeResults(results);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">å¯¹å†²å¹³ä»“å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function closePositionOnExchange(exchange, symbol) {
            const response = await fetch('/api/close_position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exchange: exchange,
                    symbol: symbol
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error);
            }
            return data.result;
        }
        
        // åŒæ­¥é‡‘é¢åŠŸèƒ½
        document.getElementById('hedge-usdt1').addEventListener('input', function() {
            if (document.getElementById('hedge-sync-amount').checked) {
                document.getElementById('hedge-usdt2').value = this.value;
            }
        });
        
        // è‡ªåŠ¨è½¬æ¢äº¤æ˜“å¯¹æ ¼å¼
        document.getElementById('hedge-symbol1').addEventListener('change', function() {
            if (document.getElementById('hedge-auto-symbol').checked) {
                const backpackSymbol = this.value.replace('USDT', '_USDT');
                // ä»…åœ¨symbol2æ— å€¼æ—¶è‡ªåŠ¨èµ‹å€¼ï¼Œé¿å…è¦†ç›–é»˜è®¤
                const symbol2Sel = document.getElementById('hedge-symbol2');
                if (!symbol2Sel.value) {
                    symbol2Sel.value = backpackSymbol;
                }
            }
        });

        // å¯¹åˆ·tabï¼šé€‰æ‹©äº¤æ˜“æ‰€ååŠ¨æ€åŠ è½½åˆçº¦äº¤æ˜“å¯¹ï¼Œä¼˜å…ˆç”¨æœ¬åœ°ç¼“å­˜
        async function loadHedgeSymbols(idx) {
            const ex = document.getElementById('hedge-ex' + idx).value;
            const symbolSel = document.getElementById('hedge-symbol' + idx);
            // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼ˆä¸ä¸»é¡µé¢ä¸€è‡´ï¼‰
            let cacheKey = 'symbols_with_leverage_' + ex;
            let cacheExpireKey = 'symbols_with_leverage_expire_' + ex;
            let cache = localStorage.getItem(cacheKey);
            let expire = localStorage.getItem(cacheExpireKey);
            let now = Date.now();
            let symbols = [];
            if (cache && expire && now < parseInt(expire)) {
                try {
                    const data = JSON.parse(cache);
                    symbols = data.symbols || [];
                    // å¤ç”¨ä¸»é¡µé¢çš„è¿‡æ»¤é€»è¾‘
                    if (ex === 'backpack') {
                        symbols = filterBackpackPerpSymbols(symbols);
                    }
                    let html = '';
                    symbols.forEach(s => {
                        let symbolStr = getSymbolStr(s);
                        if (ex === 'backpack' && symbolStr) symbolStr = symbolStr.replace(/-/g, '_');
                        html += `<option value="${symbolStr}">${symbolStr}</option>`;
                    });
                    symbolSel.innerHTML = html;
                    // è®¾ç½®é»˜è®¤é€‰ä¸­backpackçš„BTC_USDC_PERP
                    if (idx === 2 && ex === 'backpack') {
                        if ([...symbolSel.options].some(opt => opt.value === 'BTC_USDC_PERP')) {
                            symbolSel.value = 'BTC_USDC_PERP';
                            loadHedgePosition(2, true);
                        }
                    }
                    return;
                } catch (e) {
                    // ç¼“å­˜è§£æå¤±è´¥ï¼Œç»§ç»­èµ°æ¥å£
                }
            }
            // 2. ç¼“å­˜æ— æ•ˆæ‰è¯·æ±‚API
            symbolSel.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            try {
                const resp = await fetch(`/api/symbols_with_leverage?exchange=${ex}`);
                const data = await resp.json();
                if (data.success) {
                    symbols = data.symbols || [];
                    if (ex === 'backpack') {
                        symbols = filterBackpackPerpSymbols(symbols);
                    }
                    let html = '';
                    symbols.forEach(s => {
                        let symbolStr = getSymbolStr(s);
                        if (ex === 'backpack' && symbolStr) symbolStr = symbolStr.replace(/-/g, '_');
                        html += `<option value="${symbolStr}">${symbolStr}</option>`;
                    });
                    symbolSel.innerHTML = html;
                    // è®¾ç½®é»˜è®¤é€‰ä¸­backpackçš„BTC_USDC_PERP
                    if (idx === 2 && ex === 'backpack') {
                        if ([...symbolSel.options].some(opt => opt.value === 'BTC_USDC_PERP')) {
                            symbolSel.value = 'BTC_USDC_PERP';
                            loadHedgePosition(2, true);
                        }
                    }
                    // æ›´æ–°ç¼“å­˜
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    localStorage.setItem(cacheExpireKey, (now + 24*60*60*1000).toString());
                } else {
                    symbolSel.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } catch (e) {
                symbolSel.innerHTML = '<option value="">ç½‘ç»œé”™è¯¯</option>';
            }
        }

        // ä¿®æ”¹æ æ†è¾“å…¥æ¡†é»˜è®¤å€¼ä¸º50ï¼Œå¹¶æ ¹æ®äº¤æ˜“æ‰€åŠ¨æ€ç¦ç”¨
        function updateHedgeLeverageInput(idx) {
            const ex = document.getElementById('hedge-ex' + idx).value;
            const levInput = document.getElementById('hedge-leverage' + idx);
            let tipId = 'hedge-leverage-tip' + idx;
            let tip = document.getElementById(tipId);
            if (!tip) {
                tip = document.createElement('div');
                tip.id = tipId;
                tip.style = 'color:#888;font-size:13px;margin-top:5px;';
                levInput.parentNode.appendChild(tip);
            }
            if (ex === 'backpack') {
                levInput.value = 50;
                levInput.disabled = true;
                tip.textContent = 'Backpacké»˜è®¤50å€æ æ†';
            } else {
                levInput.disabled = false;
                tip.textContent = '';
            }
        }
        // ç›‘å¬é¡µé¢äº¤æ˜“æ‰€åˆ‡æ¢
        ['hedge-ex1','hedge-ex2'].forEach((id, idx) => {
            document.getElementById(id).addEventListener('change', function() {
                updateHedgeLeverageInput(idx+1);
            });
        });
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ æ†è¾“å…¥æ¡†
        updateHedgeLeverageInput(1);
        updateHedgeLeverageInput(2);

        // åˆ·æ–°å¯¹åˆ·tabçš„æŒä»“ä¿¡æ¯
        async function loadHedgePosition(idx, showLoading = false) {
            const ex = document.getElementById('hedge-ex' + idx).value;
            const symbol = document.getElementById('hedge-symbol' + idx).value;
            const posDiv = document.getElementById('hedge-position' + idx + '-show');
            if (!symbol) {
                posDiv.innerHTML = '';
                return;
            }
            if (showLoading) {
                posDiv.innerHTML = '<span style="color:#888">åŠ è½½æŒä»“...</span>';
            }
            try {
                const resp = await fetch(`/api/account?exchange=${ex}`);
                const data = await resp.json();
                if (!data.success) {
                    posDiv.innerHTML = '<span style="color:red">è·å–å¤±è´¥</span>';
                    return;
                }
                const positions = data.positions || [];
                let pos = positions.find(p => p.symbol === symbol && (parseFloat(p.positionAmt || p.position_amt || p.netQuantity || 0) !== 0));
                if (!pos) {
                    posDiv.innerHTML = '<span style="color:#888">æ— æŒä»“</span>';
                    return;
                }
                let amt = pos.positionAmt || pos.position_amt || pos.netQuantity || 0;
                let entry = pos.entryPrice || pos.entry_price || '--';
                let pnl = pos.pnlUnrealized ?? pos.unrealizedProfit ?? pos.unrealizedPnl ?? pos.unrealized_profit ?? '--';
                posDiv.innerHTML = `<b>æŒä»“é‡:</b> ${amt} <b>å¼€ä»“ä»·:</b> ${entry} <b>æœªå®ç°ç›ˆäº:</b> ${pnl}`;
            } catch (e) {
                posDiv.innerHTML = '<span style="color:red">ç½‘ç»œé”™è¯¯</span>';
            }
        }
        // æŒä»“å±•ç¤ºåŒºæ¯15ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆé™é»˜åˆ·æ–°ï¼‰
        setInterval(() => {
            loadHedgePosition(1, false);
            loadHedgePosition(2, false);
        }, 15000);
        // é¡µé¢åˆå§‹åŒ–å’Œæ‰‹åŠ¨åˆ‡æ¢æ—¶ä¾ç„¶æ˜¾ç¤ºåŠ è½½
        loadHedgePosition(1, true);
        loadHedgePosition(2, true);

        // ------------------å¥—åˆ©æ¨¡å—ä¸“ç”¨JS------------------
        // å…¶ä½™JSè¯·å‚è€ƒå¯¹åˆ·tabï¼Œæ‰€æœ‰hedge-ç›¸å…³å‡æ‰¹é‡æ›¿æ¢ä¸ºarbi-ï¼Œå‡½æ•°å/å˜é‡åå”¯ä¸€åŒ–
        // 1. äº¤æ˜“å¯¹åŠ è½½
        async function loadArbiSymbols(idx) {
            const ex = document.getElementById('arbi-ex' + idx).value;
            const symbolSel = document.getElementById('arbi-symbol' + idx);
            let cacheKey = 'symbols_with_leverage_' + ex;
            let cacheExpireKey = 'symbols_with_leverage_expire_' + ex;
            let cache = localStorage.getItem(cacheKey);
            let expire = localStorage.getItem(cacheExpireKey);
            let now = Date.now();
            let symbols = [];
            if (cache && expire && now < parseInt(expire)) {
                try {
                    const data = JSON.parse(cache);
                    symbols = data.symbols || [];
                    if (ex === 'backpack') {
                        symbols = filterBackpackPerpSymbols(symbols);
                    }
                    let html = '';
                    symbols.forEach(s => {
                        let symbolStr = getSymbolStr(s);
                        if (ex === 'backpack' && symbolStr) symbolStr = symbolStr.replace(/-/g, '_');
                        html += `<option value="${symbolStr}">${symbolStr}</option>`;
                    });
                    symbolSel.innerHTML = html;
                    // è®¾ç½®é»˜è®¤é€‰ä¸­backpackçš„BTC_USDC_PERP
                    if (idx === 2 && ex === 'backpack') {
                        if ([...symbolSel.options].some(opt => opt.value === 'BTC_USDC_PERP')) {
                            symbolSel.value = 'BTC_USDC_PERP';
                            loadArbiPosition(2, true);
                        }
                    }
                    return;
                } catch (e) {}
            }
            symbolSel.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            try {
                const resp = await fetch(`/api/symbols_with_leverage?exchange=${ex}`);
                const data = await resp.json();
                if (data.success) {
                    symbols = data.symbols || [];
                    if (ex === 'backpack') {
                        symbols = filterBackpackPerpSymbols(symbols);
                    }
                    let html = '';
                    symbols.forEach(s => {
                        let symbolStr = getSymbolStr(s);
                        if (ex === 'backpack' && symbolStr) symbolStr = symbolStr.replace(/-/g, '_');
                        html += `<option value="${symbolStr}">${symbolStr}</option>`;
                    });
                    symbolSel.innerHTML = html;
                    if (idx === 2 && ex === 'backpack') {
                        if ([...symbolSel.options].some(opt => opt.value === 'BTC_USDC_PERP')) {
                            symbolSel.value = 'BTC_USDC_PERP';
                            loadArbiPosition(2, true);
                        }
                    }
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    localStorage.setItem(cacheExpireKey, (now + 24*60*60*1000).toString());
                } else {
                    symbolSel.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } catch (e) {
                symbolSel.innerHTML = '<option value="">ç½‘ç»œé”™è¯¯</option>';
            }
        }
        // 2. æ æ†è¾“å…¥æ¡†è”åŠ¨
        function updateArbiLeverageInput(idx) {
            const ex = document.getElementById('arbi-ex' + idx).value;
            const input = document.getElementById('arbi-leverage' + idx);
            if (ex === 'backpack') {
                input.value = 50;
                input.disabled = true;
            } else {
                input.disabled = false;
            }
        }
        // 3. é‡‘é¢åŒæ­¥
        document.getElementById('arbi-usdt1').addEventListener('input', function() {
            if (document.getElementById('arbi-sync-amount').checked) {
                document.getElementById('arbi-usdt2').value = this.value;
            }
        });

        // 4. è‡ªåŠ¨è½¬æ¢äº¤æ˜“å¯¹æ ¼å¼
        document.getElementById('arbi-symbol1').addEventListener('change', function() {
            if (document.getElementById('arbi-auto-symbol').checked) {
                const backpackSymbol = this.value.replace('USDT', '_USDT');
                const symbol2Sel = document.getElementById('arbi-symbol2');
                if (!symbol2Sel.value) {
                    symbol2Sel.value = backpackSymbol;
                }
            }
        });

        // 5. æŒä»“åŠ è½½
        async function loadArbiPosition(idx, showLoading = false) {
            const ex = document.getElementById('arbi-ex' + idx).value;
            const symbol = document.getElementById('arbi-symbol' + idx).value;
            const posDiv = document.getElementById('arbi-position' + idx + '-show');
            if (!symbol) {
                posDiv.innerHTML = '';
                return;
            }
            if (showLoading) {
                posDiv.innerHTML = '<span style="color:#888">åŠ è½½æŒä»“...</span>';
            }
            try {
                const resp = await fetch(`/api/account?exchange=${ex}`);
                const data = await resp.json();
                if (!data.success) {
                    posDiv.innerHTML = '<span style="color:red">è·å–å¤±è´¥</span>';
                    return;
                }
                const positions = data.positions || [];
                let pos = positions.find(p => p.symbol === symbol && (parseFloat(p.positionAmt || p.position_amt || p.netQuantity || 0) !== 0));
                if (pos) {
                    let amt = pos.positionAmt || pos.position_amt || pos.netQuantity || 0;
                    let entry = pos.entryPrice || pos.entry_price || '--';
                    // ä¼˜å…ˆå…¼å®¹Backpackçš„pnlUnrealized
                    let pnl = pos.pnlUnrealized ?? pos.unrealizedProfit ?? pos.unrealizedPnl ?? pos.unrealized_profit ?? '--';
                    posDiv.innerHTML = `<b>æŒä»“é‡:</b> ${amt} <b>å¼€ä»“ä»·:</b> ${entry} <b>æœªå®ç°ç›ˆäº:</b> ${pnl}`;
                } else {
                    posDiv.innerHTML = '<span style="color:#888">æ— æŒä»“</span>';
                }
            } catch (e) {
                posDiv.innerHTML = '<span style="color:red">ç½‘ç»œé”™è¯¯</span>';
            }
        }

        // 6. ä¸€é”®å¥—åˆ©ä¸‹å•
        async function placeArbiOrders() {
            const resultDiv = document.getElementById('arbi-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æ‰§è¡Œå¥—åˆ©ä¸‹å•...</div>';
            
            const ex1 = document.getElementById('arbi-ex1').value;
            const symbol1 = document.getElementById('arbi-symbol1').value;
            const side1 = document.getElementById('arbi-side1').value;
            const usdt1 = document.getElementById('arbi-usdt1').value;
            const lev1 = document.getElementById('arbi-leverage1').value;
            
            const ex2 = document.getElementById('arbi-ex2').value;
            const symbol2 = document.getElementById('arbi-symbol2').value;
            const side2 = document.getElementById('arbi-side2').value;
            const usdt2 = document.getElementById('arbi-usdt2').value;
            const lev2 = document.getElementById('arbi-leverage2').value;
            
            if (!symbol1 || !symbol2) {
                resultDiv.innerHTML = '<div class="alert alert-danger">è¯·é€‰æ‹©äº¤æ˜“å¯¹</div>';
                return;
            }
            
            try {
                const [asterResult, backpackResult] = await Promise.allSettled([
                    fetch('/api/hedge_order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            exchange: ex1,
                            symbol: symbol1,
                            side: side1,
                            usdt_amount: usdt1,
                            leverage: lev1
                        })
                    }).then(r => r.json()),
                    fetch('/api/hedge_order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            exchange: ex2,
                            symbol: symbol2,
                            side: side2,
                            usdt_amount: usdt2,
                            leverage: lev2
                        })
                    }).then(r => r.json())
                ]);
                
                let html = '';
                if (asterResult.status === 'fulfilled') {
                    html += `<div><b>äº¤æ˜“æ‰€1(${ex1}):</b> ${asterResult.value.success ? 'ä¸‹å•æˆåŠŸ' : 'å¤±è´¥: ' + asterResult.value.error}</div>`;
                } else {
                    html += `<div><b>äº¤æ˜“æ‰€1(${ex1}):</b> å¤±è´¥: ${asterResult.reason.message}</div>`;
                }
                
                if (backpackResult.status === 'fulfilled') {
                    html += `<div><b>äº¤æ˜“æ‰€2(${ex2}):</b> ${backpackResult.value.success ? 'ä¸‹å•æˆåŠŸ' : 'å¤±è´¥: ' + backpackResult.value.error}</div>`;
                } else {
                    html += `<div><b>äº¤æ˜“æ‰€2(${ex2}):</b> å¤±è´¥: ${backpackResult.reason.message}</div>`;
                }
                
                resultDiv.innerHTML = html;
                // ä¸‹å•åè‡ªåŠ¨åˆ·æ–°æŒä»“å±•ç¤º
                loadArbiPosition(1);
                loadArbiPosition(2);
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">å¥—åˆ©ä¸‹å•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // 7. ä¸€é”®å¹³ä»“
        // é˜²æ­¢é‡å¤å¹³ä»“
        let arbiClosing = false;
        function arbiCloseAll() {
            console.log('arbiCloseAll è¢«è°ƒç”¨');
            closeArbiPositions();
        }
        async function closeArbiPositions() {
            if (arbiClosing) {
                console.log('æ­£åœ¨å¹³ä»“ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
                return;
            }
            arbiClosing = true;
            console.log('closeArbiPositions è¢«è°ƒç”¨');
            const resultDiv = document.getElementById('arbi-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æ‰§è¡Œå¥—åˆ©å¹³ä»“...</div>';
            const asterSymbol = document.getElementById('arbi-symbol1').value;
            const backpackSymbol = document.getElementById('arbi-symbol2').value;
            try {
                const [asterResult, backpackResult] = await Promise.allSettled([
                    closeArbiPositionOnExchange('aster', asterSymbol),
                    closeArbiPositionOnExchange('backpack', backpackSymbol)
                ]);
                let results = { aster: null, backpack: null };
                if (asterResult.status === 'fulfilled') {
                    results.aster = asterResult.value;
                } else {
                    results.aster = { error: asterResult.reason };
                }
                if (backpackResult.status === 'fulfilled') {
                    results.backpack = backpackResult.value;
                } else {
                    results.backpack = { error: backpackResult.reason };
                }
                displayArbiResults(results);
                // å¹³ä»“åè‡ªåŠ¨åˆ·æ–°æŒä»“
                loadArbiPosition(1, true);
                loadArbiPosition(2, true);
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">å¥—åˆ©å¹³ä»“å¤±è´¥: ${error.message}</div>`;
            }
            arbiClosing = false;
        }

        async function closeArbiPositionOnExchange(exchange, symbol) {
            const response = await fetch('/api/close_position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exchange: exchange,
                    symbol: symbol
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error);
            }
            return data.result;
        }

        function displayArbiResults(results) {
            const resultDiv = document.getElementById('arbi-result');
            let html = '<div class="card"><h4>å¥—åˆ©æ“ä½œç»“æœ</h4>';
            
            // Asterç»“æœ
            html += '<div style="margin-bottom: 15px;"><strong>Asteräº¤æ˜“æ‰€:</strong>';
            if (results.aster.error) {
                html += `<div class="alert alert-danger">å¤±è´¥: ${results.aster.error}</div>`;
            } else {
                html += `<div class="alert alert-success">æˆåŠŸ: è®¢å•ID ${results.aster.orderId || 'N/A'}</div>`;
            }
            html += '</div>';
            
            // Backpackç»“æœ
            html += '<div style="margin-bottom: 15px;"><strong>Backpackäº¤æ˜“æ‰€:</strong>';
            if (results.backpack.error) {
                html += `<div class="alert alert-danger">å¤±è´¥: ${results.backpack.error}</div>`;
            } else {
                html += `<div class="alert alert-success">æˆåŠŸ: è®¢å•ID ${results.backpack.orderId || 'N/A'}</div>`;
            }
            html += '</div>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // 8. å¥—åˆ©tabæŒä»“å±•ç¤ºåŒºæ¯15ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(() => {
            loadArbiPosition(1);
            loadArbiPosition(2);
        }, 15000);

        // 9. é¡µé¢åˆå§‹åŒ–æ—¶è®¾ç½®å¥—åˆ©tabé»˜è®¤å€¼
        window.addEventListener('DOMContentLoaded', function() {
            // å¥—åˆ©tabé»˜è®¤å€¼è®¾ç½®
            document.getElementById('arbi-ex1').value = 'aster';
            document.getElementById('arbi-ex2').value = 'backpack';
            document.getElementById('arbi-side1').value = 'BUY';
            document.getElementById('arbi-side2').value = 'SELL';
            document.getElementById('arbi-usdt1').value = 150;
            document.getElementById('arbi-usdt2').value = 150;
            
            // å…ˆè®¾ç½®äº¤æ˜“æ‰€ï¼Œå†åˆ†åˆ«åŠ è½½symbolsï¼Œä¿è¯æ•°æ®æºæ­£ç¡®
            loadArbiSymbols(1);
            loadArbiSymbols(2);
            loadArbiPosition(1, true);
            loadArbiPosition(2, true);
        });

        // 10. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¿€æ´»ä¸Šæ¬¡tab
        window.addEventListener('DOMContentLoaded', function() {
            const lastTab = localStorage.getItem('activeTab') || 'overview';
            // è§¦å‘ä¸€æ¬¡tabåˆ‡æ¢
            const tabBtn = Array.from(document.querySelectorAll('.tab')).find(tab => tab.textContent.includes(
                lastTab === 'overview' ? 'è´¦æˆ·æ¦‚è§ˆ' :
                lastTab === 'trading' ? 'äº¤æ˜“æ“ä½œ' :
                lastTab === 'hedge' ? 'å¯¹åˆ·å¯¹å†²' :
                lastTab === 'arbitrage' ? 'å¥—åˆ©æ¨¡å—' :
                lastTab === 'orders' ? 'è®¢å•å†å²' :
                lastTab === 'pnl' ? 'ç›ˆäºå†å²' : 'è´¦æˆ·æ¦‚è§ˆ'
            ));
            if (tabBtn) {
                // æ‰‹åŠ¨è§¦å‘ç‚¹å‡»äº‹ä»¶
                tabBtn.click();
            }
        });

        // 11. å¥—åˆ©æ¨¡å—ä¹°1å–1ä»·æ ¼è‡ªåŠ¨åˆ·æ–°
        async function updateArbiOrderbook(idx) {
            console.log('è°ƒç”¨updateArbiOrderbook', idx);
            const ex = document.getElementById('arbi-ex' + idx).value;
            const symbol = document.getElementById('arbi-symbol' + idx).value;
            const span = document.getElementById('arbi-orderbook' + idx);
            let ask1 = null, bid1 = null;
            if (!symbol) {
                span.textContent = 'å–1ä»·æ ¼ï¼š--ã€€ä¹°1ä»·æ ¼ï¼š--';
            } else {
                try {
                    const resp = await fetch(`/api/orderbook/${symbol}?exchange=${ex}`);
                    const data = await resp.json();
                    if (data.success && data.orderbook) {
                        const asks = data.orderbook.asks;
                        const bids = data.orderbook.bids;
                        ask1 = asks && asks.length ? Number(asks[0][0]) : null;
                        bid1 = bids && bids.length ? Number(bids[0][0]) : null;
                        span.textContent = `å–1ä»·æ ¼ï¼š${ask1??'--'}ã€€ä¹°1ä»·æ ¼ï¼š${bid1??'--'}`;
                    } else {
                        span.textContent = 'å–1ä»·æ ¼ï¼š--ã€€ä¹°1ä»·æ ¼ï¼š--';
                    }
                } catch (e) {
                    span.textContent = 'å–1ä»·æ ¼ï¼š--ã€€ä¹°1ä»·æ ¼ï¼š--';
                }
            }
            window['arbi_ask'+idx] = ask1;
            window['arbi_bid'+idx] = bid1;
            console.log('èµ‹å€¼å', idx, window['arbi_ask'+idx], window['arbi_bid'+idx]);
            updateArbiDiff();
        }
        // diff1/diff2è®¡ç®—ä¸å±•ç¤ºï¼ˆåªåœ¨ä¸€é”®å¥—åˆ©åŒºå±•ç¤ºï¼‰
        function updateArbiDiff() {
            console.log('è°ƒç”¨updateArbiDiff');
            let diff1 = '--', diff2 = '--';
            if(!isNaN(window.arbi_bid1) && !isNaN(window.arbi_ask2)) diff1 = (window.arbi_bid1 - window.arbi_ask2).toFixed(2);
            if(!isNaN(window.arbi_bid2) && !isNaN(window.arbi_ask1)) diff2 = (window.arbi_bid2 - window.arbi_ask1).toFixed(2);
            document.getElementById('arbi-diff').textContent = `diff1 = ${diff1}ï¼Œdiff2 = ${diff2}`;
            console.log('é¡µé¢diffå†…å®¹', document.getElementById('arbi-diff').textContent);
            // è‡ªåŠ¨åˆ¤æ–­æ–¹å‘
            const threshold = Number(document.getElementById('arbi-threshold').value);
            if(!isNaN(threshold)) {
                if(Number(diff1) > threshold) {
                    document.getElementById('arbi-side2').value = 'BUY';
                    document.getElementById('arbi-side1').value = 'SELL';
                } else if(Number(diff2) > threshold) {
                    document.getElementById('arbi-side2').value = 'SELL';
                    document.getElementById('arbi-side1').value = 'BUY';
                }
            }
            tryAutoArbitrage();
            tryAutoClose();
        }
        // ç›‘å¬é˜ˆå€¼è¾“å…¥å˜åŒ–ï¼Œå®æ—¶è§¦å‘è‡ªåŠ¨åˆ¤æ–­
        const arbiThresholdInput = document.getElementById('arbi-threshold');
        arbiThresholdInput.addEventListener('input', updateArbiDiff);
        // ç»‘å®šå¥—åˆ©tabä¸‹æ‹‰æ¡†äº‹ä»¶
        document.getElementById('arbi-ex1').addEventListener('change', function() { updateArbiOrderbook(1); });
        document.getElementById('arbi-symbol1').addEventListener('change', function() { updateArbiOrderbook(1); });
        document.getElementById('arbi-ex2').addEventListener('change', function() { updateArbiOrderbook(2); });
        document.getElementById('arbi-symbol2').addEventListener('change', function() { updateArbiOrderbook(2); });
        // é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨åŠ è½½
        window.addEventListener('DOMContentLoaded', function() {
            updateArbiOrderbook(1);
            updateArbiOrderbook(2);
        });
        // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°å¥—åˆ©æ¨¡å—ä¹°1å–1ä»·æ ¼
        setInterval(function() {
            updateArbiOrderbook(1);
            updateArbiOrderbook(2);
        }, 3000);

        // è‡ªåŠ¨å¥—åˆ©æ ¸å¿ƒé€»è¾‘
        let arbiAutoTrading = false;
        document.getElementById('arbi-auto-enable').addEventListener('change', function() {
            arbiAutoTrading = this.checked;
        });
        // è‡ªåŠ¨å¥—åˆ©ä¸‹å•é˜²æ­¢é‡å¤
        let arbiOpening = false;
        async function tryAutoArbitrage() {
            if (!arbiAutoTrading) return;
            if (arbiOpening) {
                console.log('è‡ªåŠ¨å¥—åˆ©ä¸‹å•ä¸­ï¼Œå¿½ç•¥æœ¬æ¬¡è§¦å‘');
                return;
            }
            const threshold = Number(document.getElementById('arbi-threshold').value);
            const bid1 = Number(window.arbi_bid1), ask1 = Number(window.arbi_ask1);
            const bid2 = Number(window.arbi_bid2), ask2 = Number(window.arbi_ask2);
            let diff1 = !isNaN(bid1) && !isNaN(ask2) ? (bid1-ask2) : null;
            let diff2 = !isNaN(bid2) && !isNaN(ask1) ? (bid2-ask1) : null;
            // æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æŒä»“
            const pos1 = await getArbiPositionAmt(1);
            const pos2 = await getArbiPositionAmt(2);
            if ((Math.abs(pos1) > 0.00001) || (Math.abs(pos2) > 0.00001)) return; // æœ‰æŒä»“ä¸è‡ªåŠ¨å¼€æ–°ä»“
            // æ»¡è¶³æ¡ä»¶è‡ªåŠ¨ä¸‹å•ï¼Œå¹¶åœ¨ä¸‹å•åè®¾ç½®å¼€ä»“æ–¹å‘
            if (diff1 !== null && diff1 > threshold) {
                arbiOpening = true;
                await placeArbiOrderAuto('SELL', 'BUY', ask2, bid1);
                window.arbi_open_diff_type = 'diff1';
                localStorage.setItem('arbi_open_diff_type', 'diff1');
                arbiOpening = false;
            } else if (diff2 !== null && diff2 > threshold) {
                arbiOpening = true;
                await placeArbiOrderAuto('BUY', 'SELL', ask1, bid2);
                window.arbi_open_diff_type = 'diff2';
                localStorage.setItem('arbi_open_diff_type', 'diff2');
                arbiOpening = false;
            }
        }
        // è·å–å¥—åˆ©æŒä»“é‡
        async function getArbiPositionAmt(idx) {
            const ex = document.getElementById('arbi-ex'+idx).value;
            const symbol = document.getElementById('arbi-symbol'+idx).value;
            try {
                const resp = await fetch(`/api/account?exchange=${ex}`);
                const data = await resp.json();
                if (!data.success) return 0;
                const positions = data.positions || [];
                let pos = positions.find(p => p.symbol === symbol);
                let amt = pos ? (parseFloat(pos.positionAmt || pos.position_amt || pos.netQuantity || 0)) : 0;
                return amt;
            } catch { return 0; }
        }
        // è‡ªåŠ¨å¥—åˆ©ä¸‹å•
        async function placeArbiOrderAuto(side1, side2, price1, price2) {
            // åªç”¨ç”¨æˆ·è®¾å®šçš„é‡‘é¢å’Œæ æ†
            const ex1 = document.getElementById('arbi-ex1').value;
            const symbol1 = document.getElementById('arbi-symbol1').value;
            const usdt1 = document.getElementById('arbi-usdt1').value;
            const lev1 = document.getElementById('arbi-leverage1').value;
            const ex2 = document.getElementById('arbi-ex2').value;
            const symbol2 = document.getElementById('arbi-symbol2').value;
            const usdt2 = document.getElementById('arbi-usdt2').value;
            const lev2 = document.getElementById('arbi-leverage2').value;
            // ä¸‹å•
            await Promise.allSettled([
                fetch('/api/hedge_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange: ex1, symbol: symbol1, side: side1, usdt_amount: usdt1, leverage: lev1 })
                }),
                fetch('/api/hedge_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange: ex2, symbol: symbol2, side: side2, usdt_amount: usdt2, leverage: lev2 })
                })
            ]);
            // ä¸‹å•åè‡ªåŠ¨åˆ·æ–°æŒä»“
            loadArbiPosition(1);
            loadArbiPosition(2);
        }
        // // diffåˆ·æ–°æ—¶è‡ªåŠ¨å°è¯•å¥—åˆ©
        // function updateArbiDiff() {
        //     // ...åŸæœ‰diffè®¡ç®—...
        //     // ...è‡ªåŠ¨åˆ¤æ–­æ–¹å‘...
        //     // æ–°å¢ï¼šè‡ªåŠ¨å¥—åˆ©
        //     tryAutoArbitrage();
        // }

        // æ–°å¢ï¼šè‡ªåŠ¨å¹³ä»“é€»è¾‘ï¼Œåªç”¨å¼€ä»“æ–¹å‘çš„diffåˆ¤æ–­
        async function tryAutoClose() {
            const closeThreshold = Number(document.getElementById('arbi-close-threshold').value);
            if (isNaN(closeThreshold)) return;
            const pos1 = await getArbiPositionAmt(1);
            const pos2 = await getArbiPositionAmt(2);
            const diff1 = !isNaN(window.arbi_bid1) && !isNaN(window.arbi_ask2) ? (window.arbi_bid1 - window.arbi_ask2) : null;
            const diff2 = !isNaN(window.arbi_bid2) && !isNaN(window.arbi_ask1) ? (window.arbi_bid2 - window.arbi_ask1) : null;
            console.log('è‡ªåŠ¨å¹³ä»“æ£€æµ‹', {
                openType: window.arbi_open_diff_type,
                pos1, pos2, diff1, diff2, closeThreshold
            });
            if (Math.abs(pos1) < 0.00001 && Math.abs(pos2) < 0.00001) return;
            if (window.arbi_open_diff_type === 'diff1' && diff1 !== null && diff1 <= closeThreshold) {
                arbiCloseAll();
                window.arbi_open_diff_type = null;
                localStorage.removeItem('arbi_open_diff_type');
            } else if (window.arbi_open_diff_type === 'diff2' && diff2 !== null && diff2 <= closeThreshold) {
                arbiCloseAll();
                window.arbi_open_diff_type = null;
                localStorage.removeItem('arbi_open_diff_type');
            }
        }

        // ç›‘å¬å¹³ä»“é˜€å€¼è¾“å…¥å˜åŒ–ï¼Œå®æ—¶è§¦å‘diffåˆ·æ–°
        document.getElementById('arbi-close-threshold').addEventListener('input', updateArbiDiff);
    </script>
</body>
</html> 