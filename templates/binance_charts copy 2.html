<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸å®‰Uæœ¬ä½åˆçº¦Kçº¿å›¾è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .controls h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .price-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .price-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .price-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .price-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .price-up {
            color: #28a745;
        }
        
        .price-down {
            color: #dc3545;
        }
        
        .refresh-btn {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .ema-signal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .ema-signal-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .ema-signal-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å¸å®‰Uæœ¬ä½åˆçº¦Kçº¿å›¾è¡¨</h1>
            <p>å®æ—¶æŸ¥çœ‹äº¤æ˜“å¯¹Kçº¿æ•°æ®ï¼Œæ”¯æŒ4å°æ—¶å’Œ15åˆ†é’Ÿå‘¨æœŸ</p>
        </div>
        
        <div class="content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls">
                <h3>ğŸ¯ äº¤æ˜“å¯¹é€‰æ‹©</h3>
                <div class="form-group">
                    <label for="symbol-select">é€‰æ‹©äº¤æ˜“å¯¹:</label>
                    <select id="symbol-select" onchange="onSymbolChange()">
                        <option value="">è¯·é€‰æ‹©äº¤æ˜“å¯¹...</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="loadSymbols()">åˆ·æ–°äº¤æ˜“å¯¹åˆ—è¡¨</button>
                <button class="btn btn-info" onclick="loadCurrentData()">åˆ·æ–°å½“å‰æ•°æ®</button>
                <div id="symbol-count" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
            </div>
            
            <!-- EMAä¿¡å·å±•ç¤ºåŒº -->
            <div class="ema-signal-grid">
                <div id="ema-signal-panel-4h" class="ema-signal-panel"></div>
                <div id="ema-signal-panel-15m" class="ema-signal-panel"></div>
            </div>
            
            <!-- ä»·æ ¼ä¿¡æ¯ -->
            <div id="price-info" class="price-info" style="display: none;">
                <h3>ğŸ’° å®æ—¶ä»·æ ¼ä¿¡æ¯</h3>
                <div class="price-grid">
                    <div class="price-item">
                        <div class="price-label">æœ€æ–°ä»·æ ¼</div>
                        <div class="price-value" id="last-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24hæ¶¨è·Œå¹…</div>
                        <div class="price-value" id="price-change">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24hæœ€é«˜ä»·</div>
                        <div class="price-value" id="high-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24hæœ€ä½ä»·</div>
                        <div class="price-value" id="low-price">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24hæˆäº¤é‡</div>
                        <div class="price-value" id="volume">--</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">24hæˆäº¤é¢</div>
                        <div class="price-value" id="quote-volume">--</div>
                    </div>
                </div>
            </div>
            
            <!-- Kçº¿å›¾è¡¨ -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>ğŸ“Š 4å°æ—¶Kçº¿å›¾</h3>
                    <div class="chart-wrapper" id="tv_chart_4h"></div>
                    <div class="chart-wrapper" style="display:none;">
                        <canvas id="chart-4h"></canvas>
                    </div>
                    <button class="btn refresh-btn" onclick="loadKlineData('4h')">åˆ·æ–°4Hæ•°æ®</button>
                </div>
                
                <div class="chart-container">
                    <h3>ğŸ“ˆ 15åˆ†é’ŸKçº¿å›¾</h3>
                    <div class="chart-wrapper" id="tv_chart_15m"></div>
                    <div class="chart-wrapper" style="display:none;">
                        <canvas id="chart-15m"></canvas>
                    </div>
                    <button class="btn refresh-btn" onclick="loadKlineData('15m')">åˆ·æ–°15Mæ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let symbolsList = [];
        let currentSymbol = '';
        let chart4h = null;
        let chart15m = null;
        let emaSignalTimer = null;
        
        // ====== ç¼“å­˜æœºåˆ¶ ======
        window.klineCache = {}; // { 'BTCUSDT-4h': {data, ts} }
        window.emaCache = {};   // { 'BTCUSDT-4h': {data, ts} }
        window.symbolsList = [];
        window.symbolLeverageMap = {};
        const KLINE_CACHE_TTL = 30 * 1000; // 30ç§’
        const EMA_CACHE_TTL = 30 * 1000;

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            // åœ¨ä¿¡å·åŒºä¸‹æ–¹æ’å…¥ä¸‹å•æœºä¼šå’Œäº¤æ˜“æ¿å—ï¼ˆä¸Šä¸‹æ’åˆ—ï¼‰
            const signalGrid = document.querySelector('.ema-signal-grid');
            if (signalGrid) {
                // ä¸‹å•æœºä¼š
                let oppoDiv = document.createElement('div');
                oppoDiv.id = 'order-opportunity-panel';
                oppoDiv.style = 'margin:32px 0 0 0;font-size:1.1em;width:100%;max-width:900px;';
                signalGrid.parentNode.insertBefore(oppoDiv, signalGrid.nextSibling);

                // äº¤æ˜“æ¿å—
                let tradeBlock = document.createElement('div');
                tradeBlock.id = 'trade-block-desc';
                tradeBlock.style = 'margin-top:24px;margin-bottom:20px;width:100%;background:#f8f9fa;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:18px 24px 18px 24px;';
                tradeBlock.innerHTML = `
<div style="font-weight:bold;font-size:1.25em;color:#2a4fa0;margin-bottom:12px;letter-spacing:1px;">äº¤æ˜“æ¿å—</div>
<div style="display:flex;gap:30px;flex-wrap:wrap;align-items:flex-start;">
  <div style="flex:1;min-width:220px;">
    <div style="margin-bottom:12px;font-size:1em;color:#333;">äº¤æ˜“æ‰€ï¼š
      <select id="trade-exchange-select" style="padding:6px 12px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;outline:none;">
        <option value="aster">aster</option>
        <option value="backpack">backpack</option>
      </select>
    </div>
    <div style="margin-bottom:12px;font-size:1em;color:#333;">æ æ†è®¾ç½®ï¼š<input id="trade-leverage" type="number" min="1" max="125" value="50" style="width:60px;padding:4px 8px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;"> <span style="color:#888;">ï¼ˆé»˜è®¤ä¸º50å€ï¼‰</span></div>
    <div id="trade-leverage-desc" style="margin-top:8px;color:#444;font-size:1em;"></div>
  </div>
  <div style="flex:1;min-width:180px;display:flex;align-items:center;flex-direction:column;">
    <div style="font-size:1em;color:#333;">è´¦æˆ·ä½™é¢ï¼š<span style='font-weight:bold;color:#2a4fa0;' id="trade-balance-usdt">åŠ è½½ä¸­...</span></div>
    <div style="margin-top:18px;margin-bottom:0;width:100%;text-align:center;">
      <span style="font-size:1em;color:#333;margin-right:8px;vertical-align:middle;">æ–¹å‘é€‰æ‹©ï¼š</span>
      <select id="trade-direction-select" style="padding:6px 12px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;outline:none;width:80%;max-width:220px;vertical-align:middle;">
        <option value="long">å¤šï¼ˆåšå¤š/ä¹°å…¥ï¼‰</option>
        <option value="short">ç©ºï¼ˆåšç©º/å–å‡ºï¼‰</option>
      </select>
      <div style="margin-top:18px;">
        <button id="btn-open-order" style="padding:8px 28px;font-size:1.08em;border:none;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-weight:bold;cursor:pointer;margin-right:18px;transition:background 0.2s;">ä¸‹å•</button>
        <button id="btn-close-order" style="padding:8px 28px;font-size:1.08em;border:none;border-radius:6px;background:linear-gradient(135deg,#f44336 0%,#ff7961 100%);color:white;font-weight:bold;cursor:pointer;transition:background 0.2s;">å¹³ä»“</button>
      </div>
    </div>
  </div>
  <div style="flex:1;min-width:220px;">
    <div style="margin-bottom:12px;font-size:1em;color:#333;">ä¸‹å•é‡‘é¢ï¼š<input id="trade-amount" type="number" min="1" value="150" style="width:80px;padding:4px 8px;font-size:1em;border:1.5px solid #e9ecef;border-radius:6px;background:#f8f9fa;"> <span style="color:#888;">ï¼ˆé»˜è®¤ä¸º150ï¼‰</span></div>
    <div style="font-size:0.98em;color:#666;">æ­¤å¤„æ˜¾ç¤ºæœ€å¤§å¯ä»¥ä¸‹å•çš„é‡‘é¢=è´¦æˆ·ä½™é¢*0.7*æ æ†å€æ•°<br><span id="trade-max-amount" style="color:#2a4fa0;font-weight:bold;font-size:1.1em;"></span></div>
  </div>
</div>
`;
                oppoDiv.parentNode.insertBefore(tradeBlock, oppoDiv.nextSibling);
                // äº‹ä»¶ç»‘å®šå’ŒåŠ¨æ€åŠŸèƒ½
                function updateMaxAmount() {
                  // ä»ä½™é¢å…ƒç´ è·å–ä¸»è¦ä½™é¢ï¼ˆä¼˜å…ˆUSDTï¼Œå…¶æ¬¡USDCï¼Œç„¶åå…¶ä»–ï¼‰
                  let mainBalance = Number(document.getElementById('trade-balance-usdt').getAttribute('data-balance')) || 0;
                  let leverage = Number(document.getElementById('trade-leverage').value) || 50;
                  let maxAmt = mainBalance * 0.7 * leverage;
                  document.getElementById('trade-max-amount').textContent = 'æœ€å¤§å¯ä¸‹å•é‡‘é¢ï¼š' + maxAmt.toFixed(2);
                  // é™åˆ¶ä¸‹å•é‡‘é¢è¾“å…¥æ¡†æœ€å¤§å€¼
                  document.getElementById('trade-amount').max = Math.floor(maxAmt);
                }
                window.updateMaxAmount = updateMaxAmount;
                document.getElementById('trade-leverage').addEventListener('input', updateMaxAmount);
                document.getElementById('trade-leverage').addEventListener('change', updateMaxAmount);
                document.getElementById('trade-leverage').addEventListener('blur', updateMaxAmount);
                document.getElementById('trade-exchange-select').addEventListener('change', function() {
                  // è‹¥é€‰æ‹©backpackï¼Œæ æ†å¼ºåˆ¶50
                  if (this.value === 'backpack') {
                    document.getElementById('trade-leverage').value = 50;
                    document.getElementById('trade-leverage').setAttribute('readonly', 'readonly');
                  } else {
                    document.getElementById('trade-leverage').removeAttribute('readonly');
                  }
                  updateAccountBalance();
                  updateLeverageDesc();
                });
                document.getElementById('trade-amount').addEventListener('input', updateMaxAmount);
                // åˆå§‹åŒ–ä½™é¢å’Œæœ€å¤§é‡‘é¢
                updateAccountBalance();
                updateLeverageDesc();
            }
            // ä¸‹å•æŒ‰é’®äº‹ä»¶
            const btnOpenOrder = document.getElementById('btn-open-order');
            if (btnOpenOrder) {
                btnOpenOrder.onclick = async function() {
                    const exchange = document.getElementById('trade-exchange-select').value;
                    const symbol = document.getElementById('symbol-select').value;
                    const amount = document.getElementById('trade-amount').value;
                    const direction = document.getElementById('trade-direction-select').value;
                    const order_type = 'MARKET'; // å¯æ‰©å±•
                    const leverage = document.getElementById('trade-leverage').value;
                    if (!symbol || !exchange || !amount || !direction) {
                        alert('è¯·å¡«å†™å®Œæ•´ä¸‹å•ä¿¡æ¯');
                        return;
                    }
                    btnOpenOrder.disabled = true;
                    btnOpenOrder.textContent = 'ä¸‹å•ä¸­...';
                    try {
                        const resp = await fetch('/api/unified_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol,
                                exchange,
                                amount,
                                direction,
                                order_type,
                                leverage
                            })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            alert('ä¸‹å•æˆåŠŸï¼');
                        } else {
                            alert('ä¸‹å•å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (e) {
                        alert('ç½‘ç»œé”™è¯¯ï¼š' + e);
                    }
                    btnOpenOrder.disabled = false;
                    btnOpenOrder.textContent = 'ä¸‹å•';
                };
            }
            // å¹³ä»“æŒ‰é’®äº‹ä»¶
            const btnCloseOrder = document.getElementById('btn-close-order');
            if (btnCloseOrder) {
                btnCloseOrder.onclick = async function() {
                    const exchange = document.getElementById('trade-exchange-select').value;
                    const symbol = document.getElementById('symbol-select').value;
                    const direction = document.getElementById('trade-direction-select').value;
                    if (!symbol || !exchange) {
                        alert('è¯·å¡«å†™å®Œæ•´å¹³ä»“ä¿¡æ¯');
                        return;
                    }
                    btnCloseOrder.disabled = true;
                    btnCloseOrder.textContent = 'å¹³ä»“ä¸­...';
                    try {
                        const resp = await fetch('/api/unified_close_position', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol,
                                exchange,
                                direction
                            })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            alert('å¹³ä»“æˆåŠŸï¼');
                        } else {
                            alert('å¹³ä»“å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (e) {
                        alert('ç½‘ç»œé”™è¯¯ï¼š' + e);
                    }
                    btnCloseOrder.disabled = false;
                    btnCloseOrder.textContent = 'å¹³ä»“';
                };
            }
        });

        // æŸ¥è¯¢è´¦æˆ·ä½™é¢å¹¶æ›´æ–°æ˜¾ç¤º
        async function updateAccountBalance() {
            const exchange = document.getElementById('trade-exchange-select').value;
            let balanceHtml = '';
            let mainBalance = 0;
            try {
                const resp = await fetch(`/api/account?exchange=${exchange}`);
                const data = await resp.json();
                if (data.success && data.account && data.account.assets) {
                    // å‚ç…§index.htmlçš„å¤„ç†æ–¹å¼ï¼šä¼˜å…ˆUSDTï¼Œå…¶æ¬¡USDCï¼Œç„¶åå…¶ä»–å¸ç§
                    let usdt = data.account.assets.find(a => a.asset === 'USDT');
                    let usdc = data.account.assets.find(a => a.asset === 'USDC');
                    
                    if (usdt && parseFloat(usdt.walletBalance) > 0) {
                        balanceHtml += `<span style='font-weight:bold;'>usdt: ${parseFloat(usdt.walletBalance).toFixed(2)}</span>`;
                        mainBalance = parseFloat(usdt.walletBalance);
                    }
                    
                    if (usdc && parseFloat(usdc.walletBalance) > 0) {
                        if (balanceHtml) balanceHtml += ', ';
                        balanceHtml += `<span style='font-weight:bold;'>usdc: ${parseFloat(usdc.walletBalance).toFixed(2)}</span>`;
                        if (!mainBalance) mainBalance = parseFloat(usdc.walletBalance);
                    }
                    
                    // æ˜¾ç¤ºå…¶ä»–æœ‰ä½™é¢çš„å¸ç§
                    data.account.assets.forEach(asset => {
                        if (asset.asset !== 'USDT' && asset.asset !== 'USDC' && parseFloat(asset.walletBalance) > 0) {
                            if (balanceHtml) balanceHtml += ', ';
                            balanceHtml += `<span style='font-weight:bold;'>${asset.asset.toLowerCase()}: ${parseFloat(asset.walletBalance).toFixed(2)}</span>`;
                            if (!mainBalance) mainBalance = parseFloat(asset.walletBalance);
                        }
                    });
                }
            } catch (e) {
                balanceHtml = '<span style="color:red;">è·å–å¤±è´¥</span>';
            }
            
            // æ›´æ–°ä½™é¢æ˜¾ç¤º
            const balanceElement = document.getElementById('trade-balance-usdt');
            balanceElement.innerHTML = balanceHtml || '<span style="color:gray;">æ— ä½™é¢</span>';
            balanceElement.setAttribute('data-balance', mainBalance);
            
            // æ›´æ–°æœ€å¤§å¯ä¸‹å•é‡‘é¢
            if (typeof updateMaxAmount === 'function') updateMaxAmount();
        }

        // äº¤æ˜“æ¿å—è¯´æ˜åŒºåŠ¨æ€æœ€å¤§æ æ†æ˜¾ç¤ºï¼ˆå¼‚æ­¥é˜²æŠ–ï¼Œç¡®ä¿æ¯æ¬¡éƒ½è¯·æ±‚APIï¼‰
        let leverageRequestId = 0;
        async function updateLeverageDesc() {
          const exchange = document.getElementById('trade-exchange-select').value;
          const symbol = document.getElementById('symbol-select').value;
          const descDiv = document.getElementById('trade-leverage-desc');
          const leverageInput = document.getElementById('trade-leverage');
          if (exchange === 'backpack') {
            descDiv.innerHTML = 'backpackäº¤æ˜“æ‰€æ‰€æœ‰ä»£å¸ä¸‹å•æ æ†ä¸º<b>50</b>';
            leverageInput.max = 50;
            if (parseInt(leverageInput.value) > 50) leverageInput.value = 50;
            return;
          }
          if (!symbol) {
            descDiv.innerHTML = '';
            leverageInput.removeAttribute('max');
            return;
          }
          descDiv.innerHTML = 'æŸ¥è¯¢ä¸­...';
          const reqId = ++leverageRequestId;
          try {
            const resp = await fetch(`/api/max_leverage?symbol=${symbol}&exchange=${exchange}`);
            const data = await resp.json();
            if (reqId !== leverageRequestId) return; // å·²æœ‰æ–°è¯·æ±‚ï¼Œä¸¢å¼ƒæ—§å“åº”
            if (data.success) {
              descDiv.innerHTML = `è¯¥å¸ç§æœ€å¤§æ æ†ï¼š<b>${data.maxLeverage}</b>å€`;
              leverageInput.max = data.maxLeverage;
              if (parseInt(leverageInput.value) > data.maxLeverage) {
                leverageInput.value = data.maxLeverage;
              }
              if (typeof updateMaxAmount === 'function') updateMaxAmount();
            } else {
              descDiv.innerHTML = 'æ— æ³•è·å–è¯¥å¸ç§æœ€å¤§æ æ†';
              leverageInput.removeAttribute('max');
              if (typeof updateMaxAmount === 'function') updateMaxAmount();
            }
          } catch {
            if (reqId !== leverageRequestId) return;
            descDiv.innerHTML = 'æ— æ³•è·å–è¯¥å¸ç§æœ€å¤§æ æ†';
            leverageInput.removeAttribute('max');
            if (typeof updateMaxAmount === 'function') updateMaxAmount();
          }
        }
        
        // åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨ï¼ˆæœ¬åœ°ç¼“å­˜+APIï¼‰
        async function loadSymbols(force=false) {
            const symbolSelect = document.getElementById('symbol-select');
            const countDiv = document.getElementById('symbol-count');
            const today = new Date().toISOString().slice(0,10);
            // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
            if (!force) {
                const cache = localStorage.getItem('binance_symbols_cache');
                const cacheDate = localStorage.getItem('binance_symbols_cache_date');
                if (cache && cacheDate === today) {
                    window.symbolsList = JSON.parse(cache);
                    renderSymbolSelect();
                    updateLeverageDesc();
                    return;
                }
            }
            symbolSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            try {
                const response = await fetch('/api/binance_symbols');
                const data = await response.json();
                if (data.success) {
                    window.symbolsList = data.symbols || [];
                    // å†™å…¥æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('binance_symbols_cache', JSON.stringify(window.symbolsList));
                    localStorage.setItem('binance_symbols_cache_date', today);
                    // è·å–æœ€å¤§æ æ†
                    const levResp = await fetch('/api/symbols_with_leverage?exchange=' + document.getElementById('trade-exchange-select').value);
                    const levData = await levResp.json();
                    window.symbolLeverageMap = {};
                    if (levData.success && levData.symbols) {
                        levData.symbols.forEach(item => {
                            window.symbolLeverageMap[item.symbol] = item.maxLeverage || item.max_leverage || 125;
                        });
                    }
                    renderSymbolSelect();
                    updateLeverageDesc();
                } else {
                    showAlert('è·å–äº¤æ˜“å¯¹å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        function renderSymbolSelect() {
            const symbolSelect = document.getElementById('symbol-select');
            const countDiv = document.getElementById('symbol-count');
            let options = '<option value="">è¯·é€‰æ‹©äº¤æ˜“å¯¹...</option>';
            window.symbolsList.forEach(symbol => {
                options += `<option value="${symbol}">${symbol}</option>`;
            });
            symbolSelect.innerHTML = options;
            countDiv.textContent = `å…± ${window.symbolsList.length} ä¸ªäº¤æ˜“å¯¹`;
            // é»˜è®¤é€‰æ‹©BTCUSDT
            if (window.symbolsList.includes('BTCUSDT')) {
                symbolSelect.value = 'BTCUSDT';
                onSymbolChange();
            }
        }
        
        // äº¤æ˜“å¯¹é€‰æ‹©å˜åŒ–
        function onSymbolChange() {
            currentSymbol = document.getElementById('symbol-select').value;
            if (emaSignalTimer) {
                clearInterval(emaSignalTimer);
            }
            if (currentSymbol) {
                updateLeverageDesc();
                loadPriceInfo();
                renderTradingView(currentSymbol);
                // åˆ†åˆ«åŠ è½½4hå’Œ15mä¿¡å·ï¼ˆé¦–æ¬¡åŠ è½½æ˜¾ç¤ºåŠ è½½ä¸­ï¼‰
                loadEmaSignal(currentSymbol, '4h', 'ema-signal-panel-4h', false);
                loadEmaSignal(currentSymbol, '15m', 'ema-signal-panel-15m', false);
                // å®šæ—¶åˆ·æ–°EMAä¿¡å·ï¼ˆä¸æ˜¾ç¤ºåŠ è½½ä¸­ï¼‰
                emaSignalTimer = setInterval(() => {
                    loadEmaSignal(currentSymbol, '4h', 'ema-signal-panel-4h', true);
                    loadEmaSignal(currentSymbol, '15m', 'ema-signal-panel-15m', true);
                }, 30000);
            } else {
                hidePriceInfo();
                clearCharts();
                document.getElementById('ema-signal-panel-4h').innerHTML = '';
                document.getElementById('ema-signal-panel-15m').innerHTML = '';
            }
        }
        
        // åŠ è½½ä»·æ ¼ä¿¡æ¯
        async function loadPriceInfo() {
            if (!currentSymbol) return;
            
            try {
                const response = await fetch(`/api/binance_ticker/${currentSymbol}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPriceInfo(data.ticker);
                } else {
                    showAlert('è·å–ä»·æ ¼ä¿¡æ¯å¤±è´¥: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ˜¾ç¤ºä»·æ ¼ä¿¡æ¯
        function displayPriceInfo(ticker) {
            const priceInfo = document.getElementById('price-info');
            priceInfo.style.display = 'block';
            
            // æ›´æ–°ä»·æ ¼æ•°æ®
            document.getElementById('last-price').textContent = parseFloat(ticker.last_price).toFixed(2);
            
            const priceChange = parseFloat(ticker.price_change_percent);
            const priceChangeElement = document.getElementById('price-change');
            priceChangeElement.textContent = priceChange.toFixed(2) + '%';
            priceChangeElement.className = 'price-value ' + (priceChange >= 0 ? 'price-up' : 'price-down');
            
            document.getElementById('high-price').textContent = parseFloat(ticker.high_price).toFixed(2);
            document.getElementById('low-price').textContent = parseFloat(ticker.low_price).toFixed(2);
            document.getElementById('volume').textContent = parseFloat(ticker.volume).toFixed(2);
            document.getElementById('quote-volume').textContent = parseFloat(ticker.quote_volume).toFixed(2);
        }
        
        // éšè—ä»·æ ¼ä¿¡æ¯
        function hidePriceInfo() {
            document.getElementById('price-info').style.display = 'none';
        }
        
        // åŠ è½½Kçº¿æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
        async function loadKlineData(interval) {
            if (!currentSymbol) return;
            const cacheKey = `${currentSymbol}-${interval}`;
            const now = Date.now();
            if (window.klineCache[cacheKey] && now - window.klineCache[cacheKey].ts < KLINE_CACHE_TTL) {
                displayKlineChart(interval === '4h' ? 'chart-4h' : 'chart-15m', window.klineCache[cacheKey].data, interval);
                return;
            }
            const chartId = interval === '4h' ? 'chart-4h' : 'chart-15m';
            const chartElement = document.getElementById(chartId);
            try {
                const response = await fetch(`/api/binance_klines/${currentSymbol}/${interval}`);
                const data = await response.json();
                if (data.success) {
                    window.klineCache[cacheKey] = {data: data.klines, ts: now};
                    displayKlineChart(chartId, data.klines, interval);
                } else {
                    showAlert(`è·å–${interval}Kçº¿å¤±è´¥: ` + data.error, 'danger');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ˜¾ç¤ºKçº¿å›¾è¡¨
        function displayKlineChart(chartId, klines, interval) {
            const ctx = document.getElementById(chartId).getContext('2d');
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (chartId === 'chart-4h' && chart4h) {
                chart4h.destroy();
            } else if (chartId === 'chart-15m' && chart15m) {
                chart15m.destroy();
            }
            
            // å‡†å¤‡æ•°æ®
            const labels = klines.map(k => new Date(k.open_time).toLocaleString());
            const prices = klines.map(k => parseFloat(k.close));
            const volumes = klines.map(k => parseFloat(k.volume));
            
            // åˆ›å»ºå›¾è¡¨
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ä»·æ ¼',
                        data: prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'æˆäº¤é‡',
                        data: volumes,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentSymbol} ${interval} Kçº¿å›¾`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ä»·æ ¼ (USDT)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æˆäº¤é‡'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            // ä¿å­˜å›¾è¡¨å¼•ç”¨
            if (chartId === 'chart-4h') {
                chart4h = chart;
            } else if (chartId === 'chart-15m') {
                chart15m = chart;
            }
        }
        
        // æ¸…é™¤å›¾è¡¨
        function clearCharts() {
            if (chart4h) {
                chart4h.destroy();
                chart4h = null;
            }
            if (chart15m) {
                chart15m.destroy();
                chart15m = null;
            }
        }
        
        // åŠ è½½å½“å‰æ•°æ®
        function loadCurrentData() {
            if (currentSymbol) {
                loadPriceInfo();
                renderTradingView(currentSymbol);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // è‡ªåŠ¨åˆ·æ–°ä»·æ ¼ä¿¡æ¯ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
            if (currentSymbol) {
                loadPriceInfo();
            }
        }, 30000);
        
        // æ¸²æŸ“TradingViewç»„ä»¶
        function renderTradingView(symbol) {
            document.getElementById('tv_chart_4h').innerHTML = '';
            document.getElementById('tv_chart_15m').innerHTML = '';
            new TradingView.widget({
                container_id: "tv_chart_4h",
                width: "100%",
                height: 400,
                symbol: "BINANCE:" + symbol + "PERP",
                interval: "240",
                timezone: "Asia/Shanghai",
                theme: "light",
                style: "1",
                locale: "zh_CN",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_top_toolbar: false,
                save_image: false,
                studies: [],
                withdateranges: true,
                hide_side_toolbar: false,
                allow_symbol_change: false,
                details: true,
                hotlist: false,
                calendar: false,
                studies_overrides: {},
                overrides: {},
            });
            new TradingView.widget({
                container_id: "tv_chart_15m",
                width: "100%",
                height: 400,
                symbol: "BINANCE:" + symbol + "PERP",
                interval: "15",
                timezone: "Asia/Shanghai",
                theme: "light",
                style: "1",
                locale: "zh_CN",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_top_toolbar: false,
                save_image: false,
                studies: [],
                withdateranges: true,
                hide_side_toolbar: false,
                allow_symbol_change: false,
                details: true,
                hotlist: false,
                calendar: false,
                studies_overrides: {},
                overrides: {},
            });
        }
        
        // EMAä¿¡å·åŠ è½½å‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
        async function loadEmaSignal(symbol, interval, panelId, isRefresh=false) {
            const panel = document.getElementById(panelId);
            const cacheKey = `${symbol}-${interval}`;
            const now = Date.now();
            if (window.emaCache[cacheKey] && now - window.emaCache[cacheKey].ts < EMA_CACHE_TTL) {
                renderEmaSignal(panel, window.emaCache[cacheKey].data, symbol, interval);
                return;
            }
            if (!isRefresh) panel.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const resp = await fetch(`/api/ema_signal?symbol=${symbol}&interval=${interval}`);
                const data = await resp.json();
                if (!data.success) {
                    panel.innerHTML = `<span style="color:red;">${data.error}</span>`;
                    return;
                }
                window.emaCache[cacheKey] = {data, ts: now};
                renderEmaSignal(panel, data, symbol, interval);
            } catch (e) {
                panel.innerHTML = `<span style="color:red;">è¯·æ±‚å¤±è´¥: ${e}</span>`;
            }
        }
        function renderEmaSignal(panel, data, symbol, interval) {
            let html = `<b>${symbol} ${interval} EMAä¿¡å·</b><br>`;
            html += `<div>æœ€æ–°æ”¶ç›˜ä»·: <b>${data.last_close}</b></div>`;
            html += `<div>æ—¶é—´: ${new Date(data.time).toLocaleString()}</div>`;
            html += `<div>å‡çº¿: `;
            for (const [k, v] of Object.entries(data.ema)) {
                html += `<span style="margin-right:10px;">${k}: <b>${parseFloat(v).toFixed(2)}</b></span>`;
            }
            html += `</div>`;
            if (data.signal.trend) {
                html += `<div>è¶‹åŠ¿ä¿¡å·: <span style="color:${data.signal.trend.includes('å¤šå¤´') ? 'green' : data.signal.trend.includes('ç©ºå¤´') ? 'red' : 'gray'};font-weight:bold">${data.signal.trend}</span></div>`;
            }
            if (data.signal.cross) {
                html += `<div>äº¤å‰ä¿¡å·: <span style="color:${data.signal.cross === 'é‡‘å‰' ? 'green' : data.signal.cross === 'æ­»å‰' ? 'red' : 'gray'};font-weight:bold">${data.signal.cross || 'æ— '}</span></div>`;
            }
            // 15mä¿¡å·ä¸‹ä¹Ÿæ˜¾ç¤ºè¶‹åŠ¿åˆ¤æ–­ï¼ˆå¦‚æœ‰ï¼‰
            if (interval === '15m' && data.trend_from_4h) {
                html += `<div>å½“å‰è¶‹åŠ¿: <span style="color:${data.trend_from_4h.includes('å¤šå¤´') ? 'green' : data.trend_from_4h.includes('ç©ºå¤´') ? 'red' : 'gray'};font-weight:bold">${data.trend_from_4h}</span></div>`;
            }
            panel.innerHTML = html;
        }
    </script>
</body>
</html> 